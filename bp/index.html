<!DOCTYPE html><html lang="en"><head>
<!--

	battleplan <ed@irc.rizon.net>, MIT-licensed
	https://dootnode.org/ed/c95/json/bp.html

-->
<meta charset="utf-8">
<title>battleplan</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>


html, body {
	color: #ccc;
	background: #222;
	font-family: sans-serif;
}
#nojs {
	color: #fc9;
	background: #222;
	text-align: center;
	padding: 2em 0;
	position: fixed;
	z-index: 9001;
	top: 0;
	left: 0;
	right: 0;
	width: 100%;
	height: 100%;
}
#topnav {
	color: #fff;
	background: #333;
	position: fixed;
	top: 0;
	left: 0;
	right: 0;
	width: 100%;
}
#bmenu {
	color: #fff;
	background: #079;
	text-decoration: none;
	border: 1px solid #000;
	cursor: pointer;
	position: fixed;
	padding: .3em .6em;
	top: 0;
	right: 0;
	font-size: 1.3em;
	font-weight: bold;
}
#topleft {
	margin-right: 2.5em;
	height: 2.4em;
}
#topleft h1 {
	font-size: 1.5em;
	text-align: center;
	margin: 0;
	padding: .2em 0;
	font-weight: normal;
}
#site {
	padding-top: 2.5em;
}
a {
	color: #0cf;
}
#tabh_row>* {
	display: inline-block;
	border: none;
	outline: none;
	margin: 0;
	padding: .1em 0 .2em 0;
	width: 33.2%;
	font-size: 1.77em;
	height: 1em;
	overflow: hidden;
	text-align: center;
}
#brow_prev:before {
	content: '¬´ ';
}
#brow_next:after {
	content: ' ¬ª';
}
#tabh_row .off {
	color: #555;
}
#tabh_col {
	font-size: 1.5em;
	padding: .5em 0;
	margin: 0;
}
#tabh_col a {
	width: 3em;
	display: inline-block;
	text-align: center;
	background: #222;
	margin: 0 .25em;
	padding: 0;
	border: none;
	outline: none;
	text-align: center;
}
#tabh_txt>* {
	width: 49%;
	color: #fc7;
	background: #111;
	font-size: 1.8em;
	position: relative;
	border: none;
	outline: none;
	text-align: center;
	margin: 0 .5%;
	padding: 0;
}
#vrowlist>* {
	font-size: 1.5em;
}
#vrowlist span {
	display: inline-block;
	text-align: left;
}
#vrowlist a {
	display: inline-block;
	background: #333;
	padding: .1em .2em;
	text-decoration: none;
}
#vrowlist hr {
	border-top: 1px solid #333;
	border-bottom: 1px solid #000;
	border-width: 1px 0;
}
.modal {
	background: #222; 232;
	position: fixed;
	overflow: scroll;
	top: 0;
	left: 0;
	right: 0;
	width: 100%;
	height: 100%;
	padding: 0;
}
.modal a {
	color: #fff;
	background: #333; 343;
	display: block;
	text-align: center;
	text-decoration: none;
	padding: .7em 0;
}
.modal a:hover {
	background: #444; 454;
}
#vdl {
	position: fixed;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	width: 100%;
	height: 100%;
	color: #fff;
	font-size: 1.5em;
	padding: 2em 0;
	text-align: center;
}
table {
	border-collapse: collapse;
}
td {
	padding: .5em;
	border: 3px solid transparent;
	border-width: 0 3px;
}
td:first-child {
	border-left: 6px solid transparent;
}
td:last-child {
	border-right: 6px solid transparent;
}
td:nth-child(2) {
	white-space: nowrap;
}
#tb tr:hover td {
	border-color: #fff;
	box-shadow: 0 0 .15em #000 inset;
}
#tb tr:hover td:nth-child(2) {
	border-left: none;
}
#tb tr.done td {
	color: #ad8;
	background: repeating-linear-gradient(
		45deg, #222, #222 10px, #2c2c2c 11px, #2c2c2c 20px);
}
#ladd_kan, #ldel_kan {
	display: block;
	font-size: 1.5em;
	padding: .5em .2em;
}
#ladd_rom, #ldel_rom {
	background: #111; 120;
	padding: .2em .3em;
}
#ladd_loc, #ldel_loc {
	color: #fff;
	background: #333; 453;
	padding: .2em .3em;
}
#addctx>a {
	display: block;
	margin: .5em;
}
#addctxinf {
	text-align: center;
}
#addctxscore {
	text-align: center;
	padding-top: .5em;
}
#addctxscore>a {
	display: inline-block;
	padding: .2em .4em;
	font-size: 2em;
	margin: 0em;
	border: .2em solid #222;
}
#vimport>*,
#vexport>* {
	margin: 1em;
}
#vimport>textarea,
#vexport>textarea {
	width: calc(100% - 3em);
	display: block;
	margin: 0 auto;
	height: 12em;
}
#vimport>input {
	width: calc(100% - 5em);
	display: block;
	margin: 0 auto;
	background: #333;
	padding: 1em 1.3em;
}
.toast {
	position: fixed;
	bottom: .5em;
	right: .6em;
	background: #333;
	color: #fff;
	border-radius: .25em;
	padding: .5em .6em;
}
.nudged {
	background: #999;
}
.sc1 td, .sc2 td, .sc3 td, .sc4 td { color: #444; }
.sc5 td, .modal a.sc5 { background: hsl(240,20%,20%); color: #888 }
.sc6 td, .modal a.sc6 { background: hsl(  0,40%,30%); }
.sc7 td, .modal a.sc7 { background: hsl( 30,70%,30%); color: #fff }
.sc8 td, .modal a.sc8 { background: hsl( 90,70%,30%); color: #fff }
.sc9 td, .modal a.sc9 { background: #fff; color: #000 }
x.sc8 td { background: hsl(270,40%,40%); color: #fff }
x.sc9 td { background: hsl( 90,70%,30%); color: #fff }
#addctxscore>a.act {
	border: .2em solid #fc0;
	box-shadow: 0 0 .2em #000 inset;
}
.notyet {
	color: #c55 !important;
	text-decoration: line-through !important;
	opacity: .5;
}
#vdelc {
	text-align: center;
}
#vdelc a {
	margin: .5em;
}
a#bdel_yes {
	margin: 2em;
	padding: 2em 0;
}
#tsrch {
	margin: 0;
	padding: 0;
	border: none;
	outline: none;
	font-size: 1.5em;
	padding: .15em .5em;
	width: calc(100% - 1em);
	border-bottom: .1em solid #0cf;
	background: #333;
	color: #fea;
}
#srchinf {
	color: #ccc;
	background: #222;
	padding: .5em .75em;
}


</style>
</head><body>
<div id="nojs" class="modal">
	<h1>enable javascript you doofus</h1>
	<p>alternatively something broke in which ccase please let me know</p>
</div>
<div id="topnav">
	<a href="#" id="bmenu">=</a>
	<div id="topleft">
		<h1 id="tabh_h1" class="viewctl"></h1>
		<input id="tsrch" class="viewctl" value="stroemer" />
		<div id="tabh_row" class="viewctl"
			><a href="#" id="brow_prev">//? <!-- jump to previous row -->
			</a><a href="#" id="brow_list"> List rows
			</a><a href="#" id="brow_next">//? <!-- jump to next row -->
		</a></div>
	</div>
	<div id="topsub">
		<div id="tabh_col" class="viewctl">
			<!-- will be automatically populated with a cell jumplist which fits the device screen -->
		</div>
		<div id="tabh_txt" class="viewctl"
			><input id="trow_in" value="paste here"
			><input id="trow_out" value="parser out"
			></input>
		</div>
		<div id="srchinf">
			<!-- will contain search results info -->
		</div>
	</div>
</div>
<div id="vmenu" class="modal">
	<a href="#" class="bcancel">„Ää Cancel</a>
	<a href="#" id="bmenu_chk">üìå View shopping list</a>
	<a href="#" id="bmenu_srch">üîç Search for circle</a>
	<a href="#" id="bmenu_row">‚Ω• Show all booths</a> <!-- ‚∫á -->
	<a href="#" id="bmenu_cir">‚≠ï Show all circles (slow!!)</a>
	<a href="#" id="bmenu_import">üìÇ Import your list</a>
	<a href="#" id="bmenu_export">üíæ Export your list</a>
	<a href="#" id="bmenu_day">üìÜ Change day (now: #)</a>
	<a href="#" id="bmenu_dload">üì≤ Download DB for Day #</a>
</div>
<div id="vday" class="modal">
	<a href="#" class="bcancel">„Ää Cancel</a>
	<a href="#" id="bmenu_day1">Âúü / 1</a>
	<a href="#" id="bmenu_day2">Êó• / 2</a>
	<a href="#" id="bmenu_day3">Êúà / 3</a>
</div>
<div id="vcirtype" class="modal">
	<a href="#" class="bcancel">„Ää Cancel</a>
	<a href="#" id="bmenu_cirkan">Sort by Kanji</a>
	<a href="#" id="bmenu_cirrom">Sort by Romaji</a>
</div>
<div id="vdl" class="modal">
	Downloading day # ...
</div>
<div id="vrowlist" class="modal">
	<!-- will be populated with list of rows -->
</div>
<div id="addctx" class="modal">
	<a href="#" class="bcancel">„Ää Cancel</a> <!-- ‚ùÆ‚´∑ -->
	<a href="#" id="badd_done">üíØ Set "Purchased"</a> <!-- üîî -->
	<a href="#" class="notyet" id="badd_urls">üîó Manage URLs</a>
	<a href="#" id="badd_rem">‚úò Delete from list</a>
	<div id="addctxinf">
		<span id="ladd_kan">// kanji</span>
		<span id="ladd_loc">// location</span>
		<span id="ladd_rom">// romaji</span>
	</div>
	<div id="addctxscore"></div>
	<div id="addctxlinks"></div>
</div>
<div id="vexport" class="modal">
	<a href="#" class="bcancel">„Ää Cancel</a> <!-- ‚ùÆ‚´∑ -->
	<p>select all the text below and copy it to some place safe, or...</p>
	<a href="#" id="export_download">download export file</a>
	<textarea id="export_text" readonly></textarea>
</div>
<div id="vimport" class="modal">
	<a href="#" class="bcancel">„Ää Cancel</a> <!-- ‚ùÆ‚´∑ -->
	<p>paste your backup below and hit the text import button, or drop a backup file on the browser below</p>
	<input id="import_file" type="file" />
	<a href="#" id="bimport_text">text import</a>
	<textarea id="timport_text"></textarea>
</div>
<div id="vdelc" class="modal">
	<a href="#" class="bcancel">„Ää Cancel</a>
	<div id="delinf">
		<span id="ldel_kan">// kanji</span>
		<span id="ldel_loc">// location</span>
		<span id="ldel_rom">// romaji</span>
	</div>
	<a href="#" id="bdel_yes">DELETE</a>
</div>
<div id="site">
	<div id="vtab">
		<table>
			<thead>
				<tr>
					<td>#</td> <!-- score -->
					<td>loc</td> <!-- day/row/col -->
					<td>kanji</td>
					<td>romaji</td>
				</tr>
			</thead>
			<tbody id="tb"></tbody>
		</table>
	</div>
</div>
<script>

// „Å†„Åë„Å©ÂÉï„ÅØ„Åù„ÅÆ„Åæ„Åæ„ÅÆ

var DAYS = ['Âúü','Êó•','Êúà'];
var HALLS = ['e1','e2','e3','e6','e5','e4','w1a','w1b','w2a','w2b'];
var ROWS = [
	'Ôº°Ôº¢Ôº£Ôº§Ôº•Ôº¶ÔºßÔº®Ôº©Ôº™Ôº´Ôº¨',
	'Ôº≠ÔºÆÔºØÔº∞Ôº±Ôº≤Ôº≥Ôº¥ÔºµÔº∂Ôº∑Ôº∏ÔºπÔº∫',
	'„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ',
	'„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç',
	'„Éé„Éè„Éë„Éí„Éî„Éï„Éó„Éò„Éö„Éõ„Éù„Éû',
	'„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠',
	'„Çå„Å´„Å¨„Å≠„ÅÆ„ÅØ„Å≤„Åµ„Å∏„Åª„Åæ„Åø„ÇÄ„ÇÅ„ÇÇ',
	'„ÇÑ„ÇÜ„Çà„Çâ„Çä„Çã',
	'„ÅÇ„Åè„Åë„Åì„Åï„Åó„Åô„Åõ„Åù„Åü„Å°„Å§„Å¶„Å®„Å™',
	'„ÅÑ„ÅÜ„Åà„Åä„Åã„Åç'
];
var BOOTHS = [];
var MAXNCOL = 0;
var active_day = -1;
var active_row;
var dbday = [];
var dbsel = [];
var lol = window.requestAnimationFrame;
var render = null;  // fp
var empty_row_msg = '???';


var ALLROWS = '';
for (var a = 0; a < ROWS.length; a++)
	ALLROWS += ROWS[a];


var DH = '0123456789';
var UH = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
var LH = 'abcdefghijklmnopqrstuvwxyz';
var DF = 'ÔºêÔºëÔºíÔºìÔºîÔºïÔºñÔºóÔºòÔºô';
var UF = 'Ôº°Ôº¢Ôº£Ôº§Ôº•Ôº¶ÔºßÔº®Ôº©Ôº™Ôº´Ôº¨Ôº≠ÔºÆÔºØÔº∞Ôº±Ôº≤Ôº≥Ôº¥ÔºµÔº∂Ôº∑Ôº∏ÔºπÔº∫';
var LF = 'ÔΩÅÔΩÇÔΩÉÔΩÑÔΩÖÔΩÜÔΩáÔΩàÔΩâÔΩäÔΩãÔΩåÔΩçÔΩéÔΩèÔΩêÔΩëÔΩíÔΩìÔΩîÔΩïÔΩñÔΩóÔΩòÔΩôÔΩö';

// hope this works
var RLOC = new RegExp(
	'([' + ALLROWS + UH + LH + '])[^' + ALLROWS + UH + LH + DH + DF + ']{0,3}([' +
	DH + DF + ']{1,2})[^' + ALLROWS + UH + LH + DH + DF + ']{0,1}([ABabÔº°Ôº¢ÔΩÅÔΩÇ]?)', 'u');


function tl(txt, from, to) {
	var re = new RegExp('[' + from + ']', 'gu');
	var dict = {};
	for (var a = 0; a < from.length; a++)
		dict[from[a]] = to[a];

	return txt.replace(re, function(c) {
		return dict[c];
	});
}


active_row = localStorage.getItem('activerow');
if (active_row == null)
	active_row = 'Ôº°';


function ebi(elm_id) {
	return document.getElementById(elm_id);
}
function ecn(classname) {
	return document.getElementsByClassName(classname);
}
function esc(txt) {
	return txt.replace(/[&#<>]/g, function(c) {
		return {
			'&': '&amp;',
			'"': '&quot;',
			'<': '&lt;',
			'>': '&gt;'
		}[c];
	});
}


function hidetoast(div) {
	if (div === undefined)
		div = this;
	
	if (div.currentTarget)
		div = div.currentTarget;
	
	//while (!div.classList.contains('toast') && div.parentNode)
	//	div = div.parentNode;
	
	if (div.parentNode !== null)
		div.parentNode.removeChild(div);
}
function nudgetoast(div) {
	div.classList.remove('nudged');
	if (div['bgcolor'])
		div.style.background = '#' + div['bgcolor'];
}
function toast(html, bgcolor) {
	var div = document.createElement('div');
	div.innerHTML = html;
	div.onclick = hidetoast;
	div.classList.add('toast');
	div.classList.add('nudged');
	if (bgcolor !== undefined)
		div['bgcolor'] = bgcolor;
	
	document.body.appendChild(div);
	setTimeout(function() { nudgetoast(div); }, 100);
	setTimeout(function() { hidetoast(div); }, 3000);
}
function toast_tab(tab, cname) {
	var ncells = 0;
	for (var a = 0; a < tab.length; a++)
		if (ncells < tab[a].length)
			ncells = tab[a].length;
	
	if (cname === undefined)
		html = ['<table>'];
	else
		html = ['<table class="' + cname + '">'];

	for (var a = 0; a < tab.length; a++)
	{
		html.push('<tr>');
		var len = tab[a].length;
		for (var b = 0; b < len; b++)
		{
			if (b == len - 1 && len < ncells)
				html.push('<td colspan="' +
					((ncells-len)+1) + '">' +
					tab[a][b] + '</td>');
			else
				html.push('<td>' + tab[a][b] + '</td>');
		}
		html.push('</tr>');
	}
	html.push('</table>');
	toast(html.join('\n'));
}
function locsort(a, b) {
	var la = a['loc'];
	var lb = b['loc'];
	
	var da = la.slice(0, 1);
	var db = lb.slice(0, 1);
	if (da < db) return -1;
	if (da > db) return -1;
	
	var ha = la.slice(2, 3);
	var hb = lb.slice(2, 3);
	if (ha === hb)
		return la.localeCompare(lb);
	
	var nha = ALLROWS.indexOf(ha);
	var nhb = ALLROWS.indexOf(hb);
	if (nha < nhb) return -1;
	if (nha > nhb) return 1;
	return 0;
}
function push_file(filename, text) {
  var elm = document.createElement('a');
  elm.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  elm.setAttribute('download', filename);

  elm.style.display = 'none';
  document.body.appendChild(elm);

  elm.click();

  document.body.removeChild(elm);
}
function iso8601ish() {
	var pad = function(num) {
		if (num < 10)
			return '0' + num;
		return num;
	};
	var d = new Date();
	return d.getUTCFullYear() + '-' +
		pad(d.getUTCMonth() + 1) +
		pad(d.getUTCDate()) + '-' +
		pad(d.getUTCHours()) +
		pad(d.getUTCMinutes()) +
		pad(d.getUTCSeconds());
}


var html = [];
for (var a = 0; a < ROWS.length; a++) {
	html.push('<span>' + HALLS[a] + '</span>');
	for (var b = 0; b < ROWS[a].length; b++)
		html.push('<a href="#">' + ROWS[a][b] + '</a>');
	html.push('<hr />');
}
ebi('vrowlist').innerHTML = html.join('\n');

var links = ebi('vrowlist').getElementsByTagName('a');
for (var a = 0, aa = links.length; a<aa; a++)
	links[a].onclick = ev_jumprow;

var html = [];
for (var a = 1; a < 10; a++)
{
	html.push('<a href="#" class="sc' + a + '" id="badd_r' + a + '">' + a + '</a>');
	if (a % 3 == 0)
		html.push('<br />');
}
ebi('addctxscore').innerHTML = html.join('');
var links = ebi('addctxscore').getElementsByTagName('a');
for (var a = 0, aa = links.length; a<aa; a++)
	links[a].onclick = ev_score;

function hide_modals(e) {
	if (e !== undefined)
		e.preventDefault();
	
	var modals = ecn('modal');
	for (var a = 0, aa = modals.length; a<aa; a++)
		modals[a].style.display = 'none';
}
function hide_viewctls(e) {
	if (e !== undefined)
		e.preventDefault();
	
	var modals = ecn('viewctl');
	for (var a = 0, aa = modals.length; a<aa; a++)
		modals[a].style.display = 'none';
	
	ebi('site').style.paddingTop = '2.5em';  // ¬Ø\_(„ÉÑ)_/¬Ø
}
function show(html_id) {
	ebi(html_id).style.display = 'block';
	ebi(html_id).scrollTop = 0;
}
function show_menu(e) {
	e.preventDefault();
	show('vmenu');
}
function show_chday(e) {
	e.preventDefault();
	hide_modals();
	show('vday');
}
function ev_chday(e) {
	e.preventDefault();
	hide_modals();
	var words = this.innerHTML.split(' ');
	var nday = parseInt(words[words.length-1], 10);
	load_day(nday);
}


function load_day(day) {
	var loaded;
	
	if (day === undefined)
	{
		loaded = localStorage.getItem('activeday');
		if (loaded == null)
			active_day = 2;
		else
			active_day = parseInt(loaded, 10);
	}
	else
		active_day = day;
	
	localStorage.setItem('activeday', active_day);
	ebi('bmenu_day').innerHTML = 'üìÜ Change day (now: ' + active_day + ')';
	ebi('bmenu_dload').innerHTML = 'üì≤ Download DB for Day ' + active_day;
	ebi('vdl').innerHTML = 'downloading database for day ' + active_day + ' ...';
	
	loaded = localStorage.getItem('day' + active_day);
	if (loaded == null)
	{
		warn([
			"<strong>== Day " + active_day + " database not downloaded ==</strong>",
			"Use the menu button top right;",
			"optionally change to another day first,",
			"then press ¬´<u>Download DB</u>¬ª to continue"
		]);
		return false;
	}
	dbday = JSON.parse(loaded);
	
	MAXNCOL = 0;
	for (var a = 0; a < ALLROWS.length; a++)
	{
		var ncols = 0;
		for (var b = 0, bb = dbday.length; b<bb; b++) {
			var rday = dbday[b]['loc'].slice(0, 1);
			var rrow = dbday[b]['loc'].slice(2, 3);
			
			if (rday != active_day) continue;
			if (rrow != ALLROWS[a]) continue;
			
			ncols++;
		}
		if (MAXNCOL < ncols)
			MAXNCOL = ncols;
	}
	
	load_sel();
	hide_modals();
	return true;
}
function load_sel() {
	loaded = localStorage.getItem('sel' + active_day);
	if (loaded == null)
	{
		dbsel = [];
		inf([
			"<strong>== Loaded day " + active_day + " ==</strong>",
			"Start adding some booths:",
			"Select ¬´<u>View all booths</u>¬ª in the menu"
		]);
	}
	else
		dbsel = JSON.parse(loaded);
	
	return true;
}
function save_sel() {
	localStorage.setItem('sel' + active_day, JSON.stringify(dbsel));
}
function showmsg(color, lines) {
	var s1 = '<tr><td colspan="4" style="color:#' + color + '">';
	var s2 = '</td></tr>';
	lines.unshift('&nbsp;');
	ebi('tb').innerHTML = s1 + lines.join(s2+s1) + s2;
	hide_modals();
}
function warn(lines) { showmsg('fc0', lines); }
function inf(lines) { showmsg('ad6', lines); }


function dl_done(v) {
	if (this.status != 200)
	{
		alert('** ERROR ' + this.status + ' FROM SERVER **\n\n' + this.responseText);
		return;
	}
	localStorage.setItem('day' + active_day, this.responseText);
	return load_day();
	
	hide_modals();
	inf([
		"<strong>== Downloaded day " + active_day + " ==</strong>",
		"You may have any number of days downloaded;",
		"Select any day (this or another one) to continue"
	]);
}
function dl_error() {
	alert('error');
}
function ev_dload() {
	var url = 'lkrxy' + active_day + '.json';
	var req = new XMLHttpRequest();
	req.onload = dl_done;
	req.onerror = dl_error;
	req.open('GET', url, true);
	req.send();

	hide_modals();
	show('vdl');
}

function refresh() {
	//var t = document.getElementsByTagName('*'); for (var a=0, aa=t.length; a<aa; a++) if (t[a].scrollTop > 0) alert(t[a].scrollTop + ' for ' + t[a].tagName + ' / ' + t[a].id);
	var o1 = document.getElementsByTagName('html')[0];
	var o2 = document.body;
	
	var obj = o1.scrollTop > o2.scrollTop ? o1 : o2;
	var ofs = obj.scrollTop;
	
	render();
	
	lol(function() { lol(function() {
		obj.scrollTop = ofs;
	})});
}
function ev_cir(sortfunc, only_faved) {
	inf(['loading']);
	lol(function() { lol(function() {
		var html = [];
		empty_row_msg = 'nothing to display in this list';
		BOOTHS = JSON.parse(JSON.stringify(dbday));
		BOOTHS.sort(sortfunc);
		draw_tbody(only_faved);
	})});
}
function ev_cirkan() {
	hide_viewctls();
	ebi('tabh_h1').innerHTML = 'All circles';
	show('tabh_h1');
	render = function() {
	};
	ev_cir((a,b) => (a.kan.localeCompare(b.kan)), false);
}
function ev_cirrom() {
	hide_viewctls();
	ebi('tabh_h1').innerHTML = 'All circles';
	show('tabh_h1');
	render = function() {
	};
	ev_cir((a,b) => (a.rom.localeCompare(b.rom)), false);
}
function ev_row() {
	render = function() {
		hide_modals();
		hide_viewctls();
		show('tabh_row');
		show('tabh_col');
		show('tabh_txt');
		goto_row(active_row);
	};
	render();
}
function ev_cirtype() {
	hide_modals();
	show('vcirtype');
}
function ev_listrows() {
	hide_modals();
	show('vrowlist');
}
function ev_jumprow(e) {
	if (e !== undefined)
		e.preventDefault();

	goto_row(this.innerHTML);
}
function goto_row(row) {
	hide_modals();
	active_row = row;
	localStorage.setItem('activerow', active_row);
	
	var ridx = ALLROWS.indexOf(row);
	
	if (ridx == 0) {
		ebi('brow_prev').classList.add('off');
		ebi('brow_prev').innerHTML = 'üôÖ';
	}
	else {
		ebi('brow_prev').classList.remove('off');
		ebi('brow_prev').innerHTML = ALLROWS[ridx-1];
	}
	
	if (ridx > ALLROWS.length - 2) {
		ebi('brow_next').classList.add('off');
		ebi('brow_next').innerHTML = 'üôÖ';
	}
	else {
		ebi('brow_next').classList.remove('off');
		ebi('brow_next').innerHTML = ALLROWS[ridx+1];
	}
	
	BOOTHS = [];
	for (var a = 0, aa = dbday.length; a<aa; a++) {
		var rday = dbday[a]['loc'].slice(0, 1);
		var rrow = dbday[a]['loc'].slice(2, 3);
		
		if (rday != active_day) continue;
		if (rrow != row) continue;
		
		//BOOTHS.push(dbday[a]['loc'].slice(3));
		BOOTHS.push(dbday[a]);
	}
	
	// should be safe since everything until the int is identical
	BOOTHS.sort((a,b) => (a.loc.localeCompare(b.loc)));
	
	empty_row_msg = 'row ' + row + ' empty on day ' + active_day;
	draw_tbody(false);

	ebi('site').style.paddingTop = '8em';  // ¬Ø\_(„ÉÑ)_/¬Ø
	
	draw_th();
}
function draw_tbody(only_faved) {
	var html = [];
	for (var a = 0, aa = BOOTHS.length; a<aa; a++)
	{
		var loc = BOOTHS[a]['loc'];
		var isdone = false;
		var score = '-';
		for (var b = 0, bb = dbsel.length; b<bb; b++)
			if (loc == dbsel[b]['loc'])
			{
				score = dbsel[b]['sc'];
				if (dbsel[b]['done'])
					isdone = true;
				
				break;
			}
		
		if (only_faved && score === '-')
			continue;
		
		var trclass = "sc" + score;
		if (isdone)
			trclass += ' done';
		
		//var ypos = loc.slice(3);
		html.push('<tr id="c' +
			loc + '" act="ev_rowclick" + class="' +
			trclass + '"><td>' +
			score + '</td><td>' +
			BOOTHS[a]['loc'] + '</td><td>' +
			esc(BOOTHS[a]['kan']) + '</td><td>' +
			esc(BOOTHS[a]['rom']) + '</td></tr>');
	}
	
	if (html.length == 0)
		html.push('<tr><td colspan="4">' +
			empty_row_msg + '</td></tr>');
	
	ebi('tb').innerHTML = html.join('\n');
	
	var rows = ebi('tb').getElementsByTagName('tr');
	for (var a = 0, aa = rows.length; a<aa; a++)
	{
		rows[a].onmousedown = ev_mousedown;
		rows[a].onmouseup = ev_mouseup;
	}
}
function draw_th() {
	var co = ebi('tabh_col');
	if (co.style.display == 'none')
		return;
	
	var width =
		parseInt(getComputedStyle(co)['width'], 10) /
		parseFloat(getComputedStyle(co)['font-size']);
	
	//var step = Math.ceil(BOOTHS.length / (width/3.5));
	var free = Math.floor(width/3.5);
	var step = Math.ceil(MAXNCOL / free);
	if (step < 1)
		step = 1;
	
	var html = [];
	for (var a = 0; a < BOOTHS.length; a += step)
	{
		var sbooth = BOOTHS[a]['loc'].slice(3);
		
		// please don't look
		var ypos = parseInt(sbooth.slice(3, 5), 10);
		if (ypos > 3)
			ypos -= 3;
		
		var scrpos = '00' + ypos;
		scrpos = scrpos.slice(-2);
		scrpos = sbooth.slice(0, 3) + scrpos + sbooth.slice(5);
		// it's ok now
		
		if (a == 0)
			html.push('<a href="#">' + sbooth + '</a>');
		else
			html.push('<a href="#c' + scrpos + '">' + sbooth + '</a>');
	}
	co.innerHTML = html.join('');
}
function ev_steprow() {
	if (this.classList.contains('off'))
		return;
	
	goto_row(this.innerHTML);
}
function tb_fields(tgt) {
	var tds = tgt.getElementsByTagName('td');
	return {
		"score": tds[0].textContent,
		"booth": tds[1].textContent,
		"kanji": tds[2].textContent,
		"romaji": tds[3].textContent
	};
}
function ev_rowclick(e, tgt) {
	if (e !== undefined)
		e.preventDefault();

	var inf = tb_fields(tgt);
	var links = ebi('addctxscore').getElementsByTagName('a');
	for (var a = 0; a < links.length; a++)
		links[a].classList.remove('act');
	
	if (inf['score'] !== '-')
		links[parseInt(inf['score'])-1].classList.add('act');

	ebi('ladd_kan').textContent = inf['kanji'];
	ebi('ladd_rom').textContent = inf['romaji'];
	ebi('ladd_loc').textContent = inf['booth'];
	
	if (tgt.classList.contains('done')) {
		ebi('badd_done').textContent = 'üîî Set "Must Buy"';
		ebi('badd_done').style.background =
			'linear-gradient(90deg,#2c2c2c,#664422)';
	}
	else {
		ebi('badd_done').textContent = 'üíö Set "Purchased"';
		ebi('badd_done').style.background =
			'linear-gradient(90deg,#2c2c2c,#446622)';
	}
	
	show('addctx');
	ebi('trow_out').value = inf['booth'];
}
function set_score(loc, score) {
	for (var a = 0, aa = dbsel.length; a < aa; a++)
		if (dbsel[a]['loc'] == loc)
		{
			dbsel[a]['sc'] = score;
			save_sel();
			return true;
		}
	
	dbsel.push({
		'loc': loc,
		'sc': score
	});
	save_sel();
}
function ev_score(e) {
	if (e !== undefined)
		e.preventDefault();

	var loc = ebi('ladd_loc').textContent;
	var score = this.textContent;
	
	set_score(loc, score);
	hide_modals();
	toast_tab([
		['score', score],
		['loc', loc],
		[ebi('ladd_kan').textContent],
		[ebi('ladd_rom').textContent]
	], 'sc' + score);
	refresh();
}
function ev_added() {
	hide_viewctls();
	ebi('tabh_h1').innerHTML = 'Shopping list';
	show('tabh_h1');
	render = function() {
		ev_cir(locsort, true);
	};
	render();
}
function ev_trowin_focus(e) {
	if (this.value == 'paste here')
		this.value = '';
}
function ev_trowin_blur(e) {
	if (this.value == '')
		this.value = 'paste here';
}
function ev_import(e) {
	if (e !== undefined)
		e.preventDefault();

	hide_modals();
	show('vimport');
}
function ev_export(e) {
	if (e !== undefined)
		e.preventDefault();

	ebi('export_text').value = gen_export();
	hide_modals();
	show('vexport');
}
function gen_export() {
	var ret = {};
	var keys = ['sel1', 'sel2', 'sel3'];
	for (var a = 1; a <= 3; a++) {
		var kt = localStorage.getItem('sel'+a);
		if (kt == null)
			continue;
		
		ret['sel'+a] = JSON.parse(kt);
	}
	return JSON.stringify(ret).replace(/},{"loc":"/g, '},\n{"loc":"');
}
function ev_export_file(e) {
	if (e !== undefined)
		e.preventDefault();

	var txt = gen_export();
	push_file("battleplan-" + iso8601ish() + ".json", txt);
}
function import_text(txt) {
	//alert(txt);
	inf(['data is now importing', 'please watch warmly']);
	lol(function() { lol(function() {
		var iv = JSON.parse(txt);
		for (var a = 1; a <= 3; a++) {
			var k = 'sel' + a;
			localStorage.removeItem(k);
			if (iv[k])
				localStorage.setItem(
					k, JSON.stringify(iv[k]));
		};
		load_day(active_day);
		ev_added();
	})});
}
function ev_import_file(e) {
	const file = this.files.item(0);
	const reader = new FileReader();
	reader.readAsText(file);
	reader.onload = function(e2) {
		import_text(reader.result);
	};
}
function ev_import_text(e) {
	if (e !== undefined)
		e.preventDefault();

	import_text(ebi('timport_text').value);
}
function ev_purchased(e) {
	var loc = ebi('ladd_loc').textContent;
	var entry = null;
	for (var a = 0, aa = dbsel.length; a<aa; a++)
		if (loc == dbsel[a]['loc'])
		{
			entry = dbsel[a];
			break;
		}
	
	var desc = ebi('ladd_loc').textContent + '<br />' +
		ebi('ladd_kan').textContent + '<br />' +
		ebi('ladd_rom').textContent;
	
	if (entry['done'])
	{
		delete entry['done'];
		toast('NEED TO BUY ' + desc, '642');
	}
	else {
		entry['done'] = 1;
		toast('Purchased ' + desc, '472');
	}
	save_sel();
	refresh();
}
function ev_remove(e) {
	if (e !== undefined)
		e.preventDefault();
	
	ebi('ldel_kan').textContent = ebi('ladd_kan').textContent;
	ebi('ldel_rom').textContent = ebi('ladd_rom').textContent;
	ebi('ldel_loc').textContent = ebi('ladd_loc').textContent;
	
	hide_modals();
	show('vdelc');
}
function ev_remove_ok(e) {
	if (e !== undefined)
		e.preventDefault();
	
	var find = ebi('ldel_loc').textContent;
	var rmlist = dbsel.filter(o => {
		return o.loc === find;
	});
	if (rmlist.length !== 1) {
		alert('cant delete, expected 1 but got ' + rmlist.length);
		return;
	}
	dbsel.splice(dbsel.indexOf(rmlist[0]), 1);
	
	save_sel();
	refresh();
}
function ev_mousedown(e) {
	e.currentTarget.mdt = Date.now();
}
function ev_mouseup(e) {
	var now = Date.now();
	var tgt = e.currentTarget;
	if (now - parseFloat(tgt.mdt) < 200)
		lol(function() { lol(function() {
			window[tgt.getAttribute('act')](e, tgt);
		})});
}
function ev_srch(e) {
	if (e !== undefined)
		e.preventDefault();

	hide_modals();
	hide_viewctls();
	show('tsrch');
	show('srchinf');
	ebi('srchinf').innerHTML = 'Search for a circle above';
	
	lol(function() { lol(function() {
		ev_tsch_input();
	})});
}
function ev_tsrch_focus(e) {
	if (this.value == 'stroemer')
		this.value = '';
}
function ev_tsrch_blur(e) {
	if (this.value == '')
		this.value = 'stroemer';
}
function ev_tsch_input(e) {
	if (e !== undefined)
		e.preventDefault();

	var txt = ebi('tsrch').value.toLowerCase();
	BOOTHS = dbday.filter(o => {
		return o.kan.toLowerCase().indexOf(txt) !== -1 ||
			o.rom.toLowerCase().indexOf(txt) !== -1;
	});
	BOOTHS.sort(locsort);
	
	var info = BOOTHS.length + ' results';
	if (BOOTHS.length > 100) {
		BOOTHS.splice(100, 999999);
		info = 'Over 100 results';
	}
	ebi('srchinf').textContent = info;
	
	render = function() {
		empty_row_msg = 'no search results';
		draw_tbody(false);
	};
	render();

	ebi('site').style.paddingTop = '4em';  // ¬Ø\_(„ÉÑ)_/¬Ø
}
function ev_trowin_input(e) {
	if (e !== undefined)
		e.preventDefault();

	BOOTHS = [];
	
	var txt = ebi('trow_in').value;
	var m = RLOC.exec(txt);
	if (!m) {
		ebi('trow_out').value = 'bad syntax';
	}
	else {
		// var DH = '0123456789';
		// var UH = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
		// var LH = 'abcdefghijklmnopqrstuvwxyz';
		// var DF = 'ÔºêÔºëÔºíÔºìÔºîÔºïÔºñÔºóÔºòÔºô';
		// var UF = 'Ôº°Ôº¢Ôº£Ôº§Ôº•Ôº¶ÔºßÔº®Ôº©Ôº™Ôº´Ôº¨Ôº≠ÔºÆÔºØÔº∞Ôº±Ôº≤Ôº≥Ôº¥ÔºµÔº∂Ôº∑Ôº∏ÔºπÔº∫';
		// var LF = 'ÔΩÅÔΩÇÔΩÉÔΩÑÔΩÖÔΩÜÔΩáÔΩàÔΩâÔΩäÔΩãÔΩåÔΩçÔΩéÔΩèÔΩêÔΩëÔΩíÔΩìÔΩîÔΩïÔΩñÔΩóÔΩòÔΩôÔΩö';
		
		var find =
			tl(m[1], UH+LH+LF, UF+UF+UF) +
			tl(m[2], DF, DH) +
			tl(m[3], UH+UF+LF, LH+LH+LH);
		
		ebi('trow_out').value = find;
		
		BOOTHS = dbday.filter(o => {
			return o['loc'].indexOf(find) !== -1;
		});
		BOOTHS.sort(locsort);
	}
	
	render = function() {
		empty_row_msg = 'no search results';
		draw_tbody(false);
	};
	render();
}

ebi('bmenu').onclick = show_menu;
ebi('bmenu_day').onclick = show_chday;
ebi('bmenu_day1').onclick = ev_chday;
ebi('bmenu_day2').onclick = ev_chday;
ebi('bmenu_day3').onclick = ev_chday;
ebi('bmenu_dload').onclick = ev_dload;
ebi('bmenu_cir').onclick = ev_cirtype;
ebi('bmenu_cirkan').onclick = ev_cirkan;
ebi('bmenu_cirrom').onclick = ev_cirrom;
ebi('bmenu_row').onclick = ev_row;
ebi('bmenu_srch').onclick = ev_srch;
ebi('brow_list').onclick = ev_listrows;
ebi('brow_prev').onclick = ev_steprow;
ebi('brow_next').onclick = ev_steprow;
ebi('bmenu_chk').onclick = ev_added;
ebi('trow_in').onfocus = ev_trowin_focus;
ebi('trow_in').onblur = ev_trowin_blur;
ebi('trow_in').oninput = ev_trowin_input;
ebi('bmenu_import').onclick = ev_import;
ebi('bmenu_export').onclick = ev_export;
ebi('export_download').onclick = ev_export_file;
ebi('import_file').onchange = ev_import_file;
ebi('bimport_text').onclick = ev_import_text;
ebi('badd_done').onclick = ev_purchased;
ebi('badd_rem').onclick = ev_remove;
ebi('bdel_yes').onclick = ev_remove_ok;
ebi('tsrch').onfocus = ev_tsrch_focus;
ebi('tsrch').onblur = ev_tsrch_blur;
ebi('tsrch').oninput = ev_tsch_input;

var t = ecn('bcancel');
for (var a=0; a<t.length; a++)
	t[a].onclick = hide_modals;

window.onresize = draw_th;


// state init
hide_viewctls();
if (load_day())
	ev_added();

//ev_row();


/*
cat Documents/all-comiket-rows.txt | shuf | while IFS= read -r x; do printf '{"loc":"2%s01a","sc":"7"},\n' "$x"; done > ~/Downloads/battleplan-shuffled.json 

while true; do for sc in 4 5 6 7 8 9 8 7 6 5; do IFS= read -r row; [ -z "$row" ] && break; printf '{"loc":"2%s01a","sc":"%s"},\n' "$row" "$sc"; done; [ -z "$row" ] && break; done < <(cat ~/Documents/all-comiket-rows.txt;) > ~/Downloads/battleplan-rainbow.json 
*/
</script></body></html>
