<!DOCTYPE html><html lang="en"><head>
<!--

	battleplan <ed@irc.rizon.net>, MIT-licensed
	https://dootnode.org/ed/c95/json/bp.html

-->
<meta charset="utf-8">
<title>cket list</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>


html, body {
	color: #ccc;
	background: #222;
	font-family: sans-serif;
}
#topnav {
	color: #fff;
	background: #333;
	position: fixed;
	top: 0;
	left: 0;
	right: 0;
	width: 100%;
}
#bmenu {
	color: #fff;
	background: #079;
	text-decoration: none;
	border: 1px solid #000;
	cursor: pointer;
	position: fixed;
	padding: .3em .6em;
	top: 0;
	right: 0;
	font-size: 1.3em;
	font-weight: bold;
}
#topleft {
	margin-right: 2.5em;
	height: 2.4em;
}
#site {
	padding-top: 2.5em;
}
a {
	color: #0cf;
}
#tabh_row>* {
	display: inline-block;
	border: none;
	outline: none;
	margin: 0;
	padding: .1em 0 .2em 0;
	width: 33.2%;
	font-size: 1.77em;
	height: 1em;
	overflow: hidden;
	text-align: center;
}
x#tabh_row a:nth-child(2) {
	text-align: center;
	background: #222;
}
x#tabh_row a:nth-child(3) {
	text-align: right;
}
#brow_prev:before {
	content: '« ';
}
#brow_next:after {
	content: ' »';
}
#tabh_row .off {
	color: #555;
}
#tabh_col {
	font-size: 1.5em;
	padding: .5em 0;
	margin: 0;
}
#tabh_col a {
	width: 3em;
	display: inline-block;
	text-align: center;
	background: #222;
	margin: 0 .25em;
	padding: 0;
	border: none;
	outline: none;
	text-align: center;
}
#tabh_txt>* {
	width: 49%;
	color: #fc7;
	background: #111;
	font-size: 1.8em;
	position: relative;
	border: none;
	outline: none;
	text-align: center;
	margin: 0 .5%;
	padding: 0;
}
#vrowlist>* {
	font-size: 1.5em;
}
#vrowlist span {
	display: inline-block;
	text-align: left;
}
#vrowlist a {
	display: inline-block;
	background: #333;
	padding: .1em .2em;
	text-decoration: none;
}
#vrowlist hr {
	border-top: 1px solid #333;
	border-bottom: 1px solid #000;
	border-width: 1px 0;
}
.modal {
	background: #024;
	position: fixed;
	overflow: scroll;
	top: 0;
	left: 0;
	right: 0;
	width: 100%;
	height: 100%;
	padding: 0 0 0 0;
}
.modal a {
	color: #fff;
	display: block;
	text-align: center;
	text-decoration: none;
	padding: .7em 0;
}
.modal a:hover {
	background: #246;
}
#vdl {
	position: fixed;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	width: 100%;
	height: 100%;
	background: #024;
	color: #fff;
	font-size: 1.5em;
	padding: 2em 0;
	text-align: center;
}
td {
	padding: .2em .5em;
}
td:nth-child(2) {
	white-space: nowrap;
}
#tb tr:hover td {
	background: #333;
}


</style>
</head><body>
<div id="topnav">
	<a href="#" id="bmenu">=</a>
	<div id="topleft">
		<div id="tabh_row" class="viewctl"
			><a href="#" id="brow_prev">//? <!-- jump to previous row -->
			</a><a href="#" id="brow_list"> List rows
			</a><a href="#" id="brow_next">//? <!-- jump to next row -->
		</a></div>
	</div>
	<div id="topsub">
		<div id="tabh_col" class="viewctl">
			<!-- will be automatically populated with a cell jumplist which fits the device screen -->
		</div>
		<div id="tabh_txt" class="viewctl"
			><input id="trow_in" value="paste here"
			><input id="trow_out" value="parser out"
			></input>
		</div>
	</div>
</div>
<div id="vmenu" class="modal">
	<a href="#" id="bmenu_cancel">◁ Cancel</a>
	<a href="#" id="bmenu_day">📆 Change day (now: #)</a>
	<a href="#" id="bmenu_chk">📌 View added booths</a>
	<a href="#" id="bmenu_srch">🔍 Search for circle</a>
	<a href="#" id="bmenu_cirkan">⭕語 View all circles (sort: kanji)</a>
	<a href="#" id="bmenu_cirrom">⭕🔡 View all circles (sort: romaji)</a>
	<a href="#" id="bmenu_row">⽥ View all booths (sort: row)</a>
	<a href="#" id="bmenu_import">📂 Import your list</a>
	<a href="#" id="bmenu_export">💾 Export your list</a>
	<a href="#" id="bmenu_dload">📲 Download DB: Day #</a>
</div>
<div id="vday" class="modal">
	<a href="#" id="bmenu_day1">土 / 1</a>
	<a href="#" id="bmenu_day2">日 / 2</a>
	<a href="#" id="bmenu_day3">月 / 3</a>
</div>
<div id="vsrchtype" class="modal">
	<a href="#" id="bmenu_srchrow">Search by row/column</a>
	<a href="#" id="bmenu_srchname">Search by circle name</a>
</div>
<div id="vdl" class="modal">
	Downloading day # ...
</div>
<div id="vrowlist" class="modal">
	<!-- will be populated with list of rows -->
</div>
<div id="site">
	<div id="vtab">
		<table>
			<thead>
				<tr>
					<td>#</td> <!-- rating -->
					<td>loc</td> <!-- day/row/col -->
					<td>kanji</td>
					<td>romaji</td>
				</tr>
			</thead>
			<tbody id="tb"></tbody>
		</table>
	</div>
</div>
<script>

// だけど僕はそのままの

var DAYS = ['土','日','月'];
var HALLS = ['e1','e2','e3','e6','e5','e4','w1a','w1b','w2a','w2b'];
var ROWS = [
	'ＡＢＣＤＥＦＧＨＩＪＫＬ',
	'ＭＮＯＰＱＲＳＴＵＶＷＸＹＺ',
	'アイウエオカキクケコサ',
	'シスセソタチツテトナニヌネ',
	'ノハパヒピフプヘペホポマ',
	'ミムメモヤユヨラリルレロ',
	'れにぬねのはひふへほまみむめも',
	'やゆよらりる',
	'あくけこさしすせそたちつてとな',
	'いうえおかき'
];
var BOOTHS = [];
var MAXNCOL = 0;
var active_day = -1;
var active_row = 'Ａ';
var dbday = [];
var dbsel = [];
var lol = window.requestAnimationFrame;


var ALLROWS = '';
for (var a = 0; a < ROWS.length; a++)
	ALLROWS += ROWS[a];


function ebi(elm_id) {
	return document.getElementById(elm_id);
}
function ecn(classname) {
	return document.getElementsByClassName(classname);
}


var html = [];
for (var a = 0; a < ROWS.length; a++) {
	html.push('<span>' + HALLS[a] + '</span>');
	for (var b = 0; b < ROWS[a].length; b++)
		html.push('<a href="#">' + ROWS[a][b] + '</a>');
	html.push('<hr />');
}
ebi('vrowlist').innerHTML = html.join('\n');
var links = ebi('vrowlist').getElementsByTagName('a');
for (var a = 0, aa = links.length; a<aa; a++)
	links[a].onclick = ev_jumprow;


function hide_modals(e) {
	if (e !== undefined)
		e.preventDefault();
	
	var modals = ecn('modal');
	for (var a = 0, aa = modals.length; a<aa; a++)
		modals[a].style.display = 'none';
}
function hide_viewctls(e) {
	if (e !== undefined)
		e.preventDefault();
	
	var modals = ecn('viewctl');
	for (var a = 0, aa = modals.length; a<aa; a++)
		modals[a].style.display = 'none';
	
	ebi('site').style.paddingTop = '2.5em';  // ¯\_(ツ)_/¯
}
function show(html_id) {
	ebi(html_id).style.display = 'block';
}
function show_menu(e) {
	e.preventDefault();
	show('vmenu');
}
function show_chday(e) {
	e.preventDefault();
	hide_modals();
	show('vday');
}
function ev_chday(e) {
	e.preventDefault();
	hide_modals();
	var words = this.innerHTML.split(' ');
	var nday = parseInt(words[words.length-1], 10);
	load_day(nday);
}


function load_day(day) {
	var loaded;
	
	if (day === undefined)
	{
		loaded = localStorage.getItem('activeday');
		if (loaded == null)
			active_day = 2;
		else
			active_day = parseInt(loaded, 10);
	}
	else
		active_day = day;
	
	localStorage.setItem('activeday', active_day);
	ebi('bmenu_day').innerHTML = '📆 Change day (now: ' + active_day + ')';
	ebi('bmenu_dload').innerHTML = '📲 Download DB: Day ' + active_day;
	ebi('vdl').innerHTML = 'downloading database for day ' + active_day + ' ...';
	
	loaded = localStorage.getItem('day' + active_day);
	if (loaded == null)
	{
		warn([
			"<strong>== Day " + active_day + " database not downloaded ==</strong>",
			"Use the menu button top right;",
			"optionally change to another day first,",
			"then press «<u>Download DB</u>» to continue"
		]);
		return false;
	}
	dbday = JSON.parse(loaded);
	
	MAXNCOL = 0;
	for (var a = 0; a < ALLROWS.length; a++)
	{
		var ncols = 0;
		for (var b = 0, bb = dbday.length; b<bb; b++) {
			var rday = dbday[b]['loc'].slice(0, 1);
			var rrow = dbday[b]['loc'].slice(2, 3);
			
			if (rday != active_day) continue;
			if (rrow != ALLROWS[a]) continue;
			
			ncols++;
		}
		if (MAXNCOL < ncols)
			MAXNCOL = ncols;
	}
	
	load_sel();
	return true;
}
function load_sel() {
	loaded = localStorage.getItem('sel' + active_day);
	if (loaded == null)
	{
		dbsel = [];
		inf([
			"<strong>== Loaded day " + active_day + " ==</strong>",
			"Start adding some booths:",
			"Select «<u>View all (by ...)</u>» in the menu"
		]);
	}
	else
		dbsel = JSON.parse(loaded);
	
	return true;
}
function save_sel() {
	localStorage.setItem('sel' + active_day, JSON.stringify(dbsel));
}
function showmsg(color, lines) {
	var s1 = '<tr><td colspan="4" style="color:#' + color + '">';
	var s2 = '</td></tr>';
	lines.unshift('&nbsp;');
	ebi('tb').innerHTML = s1 + lines.join(s2+s1) + s2;
	hide_modals();
}
function warn(lines) { showmsg('fc0', lines); }
function inf(lines) { showmsg('ad6', lines); }


function dl_done(v) {
	if (this.status != 200)
	{
		alert('** ERROR ' + this.status + ' FROM SERVER **\n\n' + this.responseText);
		return;
	}
	localStorage.setItem('day' + active_day, this.responseText);
	return load_day();
	
	hide_modals();
	inf([
		"<strong>== Downloaded day " + active_day + " ==</strong>",
		"You may have any number of days downloaded;",
		"Select any day (this or another one) to continue"
	]);
}
function dl_error() {
	alert('error');
}
function ev_dload() {
	var url = 'lkrxy' + active_day + '.json';
	var req = new XMLHttpRequest();
	req.onload = dl_done;
	req.onerror = dl_error;
	req.open('GET', url, true);
	req.send();

	hide_modals();
	show('vdl');
}
function ev_cir(sortfunc) {
	hide_viewctls();
	inf(['loading']);
	lol(function() { lol(function() {
		var html = [];
		var dbd = JSON.parse(JSON.stringify(dbday));
		dbd.sort(sortfunc);
		for (var a = 0; a < dbd.length; a++)
		{
			html.push('<tr><td>?</td><td>' + dbd[a].loc + '</td><td>' + dbd[a].kan + '</td><td>' + dbd[a].rom + '</td></tr>');
		}
		ebi('tb').innerHTML = html.join('\n');
	})});
}
function ev_cirkan() {
	ev_cir((a,b) => (a.kan.localeCompare(b.kan)));
}
function ev_cirrom() {
	ev_cir((a,b) => (a.rom.localeCompare(b.rom)));
}
function ev_row() {
	hide_modals();
	hide_viewctls();
	show('tabh_row');
	show('tabh_col');
	show('tabh_txt');
}
function ev_srch() {
	hide_modals();
	show('vsrchtype');
}
function ev_srchrow() {
	
}
function ev_srchname() {
	
}
function ev_listrows() {
	hide_modals();
	show('vrowlist');
}
function ev_jumprow(e) {
	if (e !== undefined)
		e.preventDefault();

	goto_row(this.innerHTML);
}
function goto_row(row) {
	hide_modals();
	active_row = row;
	var ridx = ALLROWS.indexOf(row);
	
	if (ridx == 0) {
		ebi('brow_prev').classList.add('off');
		ebi('brow_prev').innerHTML = '🙅';
	}
	else {
		ebi('brow_prev').classList.remove('off');
		ebi('brow_prev').innerHTML = ALLROWS[ridx-1];
	}
	
	if (ridx > ALLROWS.length - 2) {
		ebi('brow_next').classList.add('off');
		ebi('brow_next').innerHTML = '🙅';
	}
	else {
		ebi('brow_next').classList.remove('off');
		ebi('brow_next').innerHTML = ALLROWS[ridx+1];
	}
	
	BOOTHS = [];
	for (var a = 0, aa = dbday.length; a<aa; a++) {
		var rday = dbday[a]['loc'].slice(0, 1);
		var rrow = dbday[a]['loc'].slice(2, 3);
		
		if (rday != active_day) continue;
		if (rrow != row) continue;
		
		//BOOTHS.push(dbday[a]['loc'].slice(3));
		BOOTHS.push(dbday[a]);
	}
	
	// should be safe since everything until the int is identical
	BOOTHS.sort((a,b) => (a.loc.localeCompare(b.loc)));
	
	var html = [];
	for (var a = 0, aa = BOOTHS.length; a<aa; a++)
	{
		var ypos = BOOTHS[a]['loc'].slice(3);
		html.push('<tr id="c' + ypos + '"><td>?</td><td>' + BOOTHS[a]['loc'] + '</td><td>' + BOOTHS[a]['kan'] + '</td><td>' + BOOTHS[a]['rom'] + '</td></tr>');
	}
	
	if (html.length == 0)
		html.push('<tr><td colspan="4">row ' + row + ' empty on day ' + active_day + '</td></tr>');
	
	ebi('tb').innerHTML = html.join('\n');
	ebi('site').style.paddingTop = '8em';  // ¯\_(ツ)_/¯
	
	draw_tabh();
}
function draw_tabh() {
	var co = ebi('tabh_col');
	if (co.style.display == 'none')
		return;
	
	var width =
		parseInt(getComputedStyle(co)['width'], 10) /
		parseFloat(getComputedStyle(co)['font-size']);
	
	//var step = Math.ceil(BOOTHS.length / (width/3.5));
	var free = Math.floor(width/3.5);
	var step = Math.ceil(MAXNCOL / free);
	if (step < 1)
		step = 1;
	
	var html = [];
	for (var a = 0; a < BOOTHS.length; a += step)
	{
		var sbooth = BOOTHS[a]['loc'].slice(3);
		
		// please don't look
		var ypos = parseInt(sbooth.slice(0, 2), 10);
		if (ypos > 3)
			ypos -= 3;
		
		var scrpos = '00' + ypos;
		scrpos = scrpos.slice(-2);
		scrpos = scrpos + sbooth.slice(2);
		// it's ok now
		
		if (a == 0)
			html.push('<a href="#">' + sbooth + '</a>');
		else
			html.push('<a href="#c' + scrpos + '">' + sbooth + '</a>');
	}
	co.innerHTML = html.join('');
}
function ev_steprow() {
	if (this.classList.contains('off'))
		return;
	
	goto_row(this.innerHTML);
}

ebi('bmenu').onclick = show_menu;
ebi('bmenu_cancel').onclick = hide_modals;
ebi('bmenu_day').onclick = show_chday;
ebi('bmenu_day1').onclick = ev_chday;
ebi('bmenu_day2').onclick = ev_chday;
ebi('bmenu_day3').onclick = ev_chday;
ebi('bmenu_dload').onclick = ev_dload;
ebi('bmenu_cirkan').onclick = ev_cirkan;
ebi('bmenu_cirrom').onclick = ev_cirrom;
ebi('bmenu_row').onclick = ev_row;
ebi('bmenu_srch').onclick = ev_srch;
ebi('bmenu_srchrow').onclick = ev_srchrow;
ebi('bmenu_srchname').onclick = ev_srchname;
ebi('brow_list').onclick = ev_listrows;
ebi('brow_prev').onclick = ev_steprow;
ebi('brow_next').onclick = ev_steprow;
window.onresize = draw_tabh;


// state init
hide_viewctls();


// let's call this a unit test
if (load_day())
{
	ev_row();
	goto_row('Ａ');
}


</script></body></html>
