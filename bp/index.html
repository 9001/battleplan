<!DOCTYPE html><html lang="en"><head>
<!--

	battleplan <ed@irc.rizon.net>, MIT-licensed
	https://ocv.me/bp/101/

-->
<meta charset="utf-8">
<title>battleplan</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>


html, body {
	color: #ccc;
	background: #222;
	font-family: sans-serif;
	touch-action: manipulation;
}
input {
	font-size: 1em;
}
#tabh_txt input {
	color: #fc7;
}
#nojs {
	color: #fc9;
	background: #222;
	text-align: center;
	padding: 2em 0;
	position: fixed;
	z-index: 9001;
	top: 0;
	left: 0;
	right: 0;
	width: 100%;
	height: 100%;
}
#topnav {
	color: #fff;
	background: #333;
	position: fixed;
	top: 0;
	left: 0;
	right: 0;
	width: 100%;
}
#bmenu {
	color: #fff;
	background: #079;
	text-decoration: none;
	border: 1px solid #000;
	cursor: pointer;
	position: fixed;
	padding: .3em .6em;
	top: 0;
	right: 0;
	font-size: 1.3em;
	font-weight: bold;
}
#topleft {
	background: #222;
	margin-right: 2.5em;
	height: 2.4em;
}
#topleft a {
	overflow: hidden;
	width: 1.3em;
	font-size: 2em;
	text-align: center;
	display: inline-block;
	text-decoration: none;
	background: #222;
	line-height: 1.2em;
}
#topleft a.act {
	background: linear-gradient(0deg,#333,#555 50%,#666 50%,#333);
}
a {
	color: #0cf;
}
#tabh_row>* {
	display: inline-block;
	border: none;
	outline: none;
	margin: 0;
	padding: .1em 0 .2em 0;
	width: 33.2%;
	font-size: 1.77em;
	height: 1em;
	overflow: hidden;
	text-align: center;
}
#brow_prev:before {
	content: '« ';
}
#brow_next:after {
	content: ' »';
}
#tabh_row .off {
	color: #555;
}
#tabh_col {
	font-size: 1.5em;
	padding: .5em 0;
	margin: 0;
}
#tabh_col a {
	width: 3em;
	display: inline-block;
	text-align: center;
	background: #222;
	margin: 0 .25em;
	padding: 0;
	border: none;
	outline: none;
	text-align: center;
}
#tabh_txt>* {
	width: 49%;
	background: #111;
	font-size: 1.8em;
	position: relative;
	border: none;
	outline: none;
	text-align: center;
	margin: 0 .5%;
	padding: 0;
}
#vrowlist>a {
	margin: 1em;
}
#vrowlistb>* {
	font-size: 1.5em;
}
#vrowlistb span {
	display: inline-block;
	text-align: left;
}
#vrowlistb a {
	display: inline-block;
	background: #333;
	padding: .1em .2em;
	text-decoration: none;
}
#vrowlistb hr {
	border-top: 1px solid #333;
	border-bottom: 1px solid #000;
	border-width: 1px 0;
}
.modal {
	background: #222;
	position: fixed;
	overflow: auto;
	top: 0;
	left: 0;
	right: 0;
	width: 100%;
	height: 100%;
	padding: 0;
}
.modal a {
	color: #fff;
	background: #333;
	display: block;
	text-align: center;
	text-decoration: none;
	padding: .7em 0;
}
.modal a:hover {
	background: #444;
}
.modal a.zoomsel {
	font-weight: bold;
	text-decoration: underline;
}
.bcancel {
	position: sticky;
	top: 0;
	box-shadow: 0 0 0 .4em #222;
	margin-bottom: .4em;
}
.bcancel::before {
	content: '«';
	position: fixed;
	bottom: .2em;
	right: .2em;
	padding: .7em .8em;
	color: #fff;
	background: #333;
	box-shadow: 0 0 0 .3em #222;
}
#vdl {
	position: fixed;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	width: 100%;
	height: 100%;
	color: #fff;
	font-size: 1.5em;
	padding: 2em 0;
	text-align: center;
}
table {
	border-collapse: collapse;
}
tr {
	scroll-margin-top: 45vh;
	scroll-margin-bottom: 40vh;
}
td {
	padding: .7em .5em;
	border: 3px solid transparent;
	border-width: 0 3px;
}
td:first-child {
	border-left: 6px solid transparent;
}
td:last-child {
	border-right: 6px solid transparent;
}
td:nth-child(2) {
	white-space: nowrap;
}
tr.hil td {
	animation: hil 1s ease-out;
	filter: brightness(1);
}
@keyframes hil {
	15% {filter:brightness(1); border-color: #fff}
	25% {filter:brightness(3); border-color: #fff; color: #fff}
	100% {filter:brightness(1)}
}
#tb tr:hover td {
	border-color: #fff;
	box-shadow: 0 0 .15em #000 inset;
}
#tb tr:hover td:nth-child(2) {
	border-left: none;
}
#tb tr.done td {
	color: #ad8;
	background: repeating-linear-gradient(
		45deg, #222, #222 10px, #2c2c2c 11px, #2c2c2c 20px);
}
#ladd_kan, #ldel_kan {
	display: block;
	font-size: 1.5em;
	padding: .5em .2em;
}
#ladd_rom, #ldel_rom {
	background: #111;
	padding: .2em .3em;
}
#ladd_loc, #ldel_loc {
	color: #fff;
	background: #333;
	padding: .2em .3em;
}
#addctx>a {
	display: block;
	margin: .5em;
}
#addctxinf {
	text-align: center;
}
#addctxsp {
	table-layout: fixed;
	width: calc(100% - 1em);
	margin: .5em 0 0 .5em;
}
#addctxsp td {
	width: 50%;
	border: none;
}
#addctxsp.ni #addctxpic {
	width: 0;
}
#addctxsp.ni #addctxscore {
	width: calc( 100% - 1em );
	text-align: center;
}
#addctxpic {
	text-align: right;
	padding: .4em 1em 0 0;
}
#addctxpic img {
	height: 12.2em;
}
#addctxsp.ni #addctxpic {
	background: #555;
}
#addctxscore {
	padding: 0;
}
#addctxscore>a {
	display: inline-block;
	padding: .2em .4em;
	font-size: 2em;
	margin: 0em;
	border: .2em solid #222;
}
#addctxlinks {
	margin: 1em 0;
}
#vimport>*,
#vexport>*,
#vurls_add>*,
#vurls_edit>* {
	margin: 1em;
}
#vimport>textarea,
#vexport>textarea {
	width: calc(100% - 3em);
	display: block;
	margin: 0 auto;
	height: 12em;
}
#vimport>input,
#vurls_add>input,
#vurls_edit>input,
#addctxqnote>input {
	width: calc(100% - 5em);
	display: block;
	margin: 0 auto;
	color: #fff;
	background: #333;
	padding: 1em 1.3em;
	border: none;
	outline: none;
}
div.center {
	margin: 1em 0;
	text-align: center;
}
div.center>div {
	display: inline-block;
	text-align: left;
}
.toast {
	position: fixed;
	bottom: .5em;
	right: .6em;
	background: #333;
	color: #fff;
	border-radius: .25em;
	padding: .5em .6em;
}
.nudged {
	background: #999;
}
#addctxscore>a.act {
	border: .2em solid #fc0;
	box-shadow: 0 0 .2em #000 inset;
}
.notyet {
	color: #f76 !important;
	text-decoration: line-through !important;
	opacity: .5;
}
#vdelc {
	text-align: center;
}
#vdelc a {
	margin: .5em;
}
a#bdel_yes {
	margin: 2em;
	padding: 2em 0;
}
#tsrch {
	margin: 0;
	padding: 0;
	border: none;
	outline: none;
	font-size: 1.5em;
	padding: .15em .5em;
	width: calc(100% - 1em);
	border-bottom: .1em solid #0cf;
	background: #333;
	color: #fea;
}
#srchinfb {
	color: #ccc;
	background: #222;
	padding: .5em .75em;
}
#vurls_list a:before {
	content: '🔖 ';
}
#added_inf {
	padding: .2em .3em;
}
#added_inf span {
	color: #c37;
	font-size: .8em;
}
#added_jump {
	padding: .2em .3em;
}
#added_jump {
	color: #d95;
}
#added_jump a {
	color: #fff;
	font-size: 1.2em;
	text-decoration: none;
	border-bottom: .2em solid #09f;
}
#added_jump span {
	color: #c37;
	font-size: .8em;
}
#vmap {
	top: 2.2em;
	height: calc(100% - 2.2em);
}
canvas {
	width: 100%;
	height: 100%;
	background: #000;
}
#bqnote {
	margin: 1em;
}
.grid2 a {
	width: 48%;
	margin: 1%;
	display: inline-block;
}
.grid2 a span {
	margin-left: .5em;
	font-weight: bold;
	font-size: 1.7em;
	line-height: 0;
}
h3 {
	margin: 1em 0 0 0;
	padding: 0;
	text-align: center;
}
.grid2+h3 {
	margin: 0;
}
#vsrchcfg {
	text-align: center;
}
#vsrchcfg>* {
	margin: .5em;
}
#vsrchcfg>div {
	text-align: left;
	line-height: 2.2em;
	display: inline-block;
}
#ccolors {
	padding: .6em;
	background: #000;
}
#vcolors p {
	padding: 0;
	margin: 1em;
}
#tcolors a {
	padding: .1em .5em;
}
#tcolors input {
	max-width: 10em;
	color: #fff;
	background: #222;
	border: 1px solid #333;
	border-width: 0 0 .1em 0;
}
#tcolors td {
	padding: .3em;
}
#tcolors td:first-child {
	padding: .3em .6em;
}



@media (min-width: 30em) {
	#addctx > a {
		display: inline-block;
		width: calc(50% - 1.1em)
	}
}
@media (min-width: 60em) {
	#addctx > a {
		display: inline-block;
		width: calc(25% - 1.1em)
	}
	.p50 {
		display: inline-block;
		width: 50%;
	}
	#ladd_kan, #ldel_kan {
		display: inline-block;
		margin-right: .6em;
	}
}

</style>
</head><body>
<div id="nojs" class="modal">
	<h1>enable javascript you doofus</h1>
	<p>alternatively something broke in which ccase please let me know</p>
</div>
<div id="topnav">
	<a href="#" id="bmenu">=</a>
	<div id="topleft">
		<a href="#" id="tbmenu_chk">📌</a>
		<a href="#" id="tbmenu_map">🗺</a>
		<a href="#" id="tbmenu_srch">🔍</a>
		<a href="#" id="tbmenu_row">⽥</a> <!-- ⺇ -->
		<!-- a href="#" id="tbmenu_cir">⭕</a -->
		<a href="#" id="tbmenu_day">📆</a>
	</div>
	<div id="topsub">
		<div id="added_inf" class="viewctl">// info about added items</div>
		<div id="added_jump" class="viewctl">// jumplist</div>
		
		<div id="tabh_row" class="viewctl"
			><a href="#" id="brow_prev">//? <!-- jump to previous row -->
			</a><a href="#" id="brow_list"> List rows
			</a><a href="#" id="brow_next">//? <!-- jump to next row -->
		</a></div>
		<div id="tabh_col" class="viewctl">
			<!-- will be automatically populated with a cell jumplist which fits the device screen -->
		</div>
		<div id="tabh_txt" class="viewctl"
			><input id="trow_in" placeholder="paste here"
			><input id="trow_out" value="parser out"
			></div>
		
		<input id="tsrch" class="viewctl" value="stroemer" sample="stroemer" />
		<div id="srchinfb" class="viewctl">
			<span id="srchinf">
				<!-- will contain search results info -->
			</span>
			<a href="#" id="bsrchcfg">(settings)</a>
		</div>
	</div>
</div>
<div id="vmenu" class="modal">
	<a href="#" class="bcancel">《 Cancel</a>
	<a href="#" id="bmenu_chk">📌 View shopping list</a>
	<a href="#" id="bmenu_map">🗺 Draw map</a>
	<a href="#" id="bmenu_srch">🔍 Search for circle</a>
	<a href="#" id="bmenu_row">⽥ Show all booths</a> <!-- ⺇ -->
	<a href="#" id="bmenu_cir">⭕ Show all circles (slow!!)</a>
	<a href="#" id="bmenu_import">📂 Import your list</a>
	<a href="#" id="bmenu_export">💾 Export your list</a>
	<a href="#" id="bmenu_settings">⚙️ Settings</a>
	<a href="#" id="bmenu_day">📆 Change day (now: #)</a>
	<a href="#" id="bmenu_dload">📲 Download DB for Day #</a>
	<a href="bp-readme/">❓ Help</a>
</div>
<div id="vcfg" class="modal">
	<a href="#" class="bcancel">《 Cancel</a>
	<a href="#" id="bcfg_srch">Configure search</a>
	<a href="#" id="bcfg_colors">Configure colors</a>
</div>
<div id="vcolors" class="modal">
	<a href="#" class="bcancel">《 Apply</a>
	<div id="ccolors"><table>
		<thead>
			<tr>
				<th>sc</th>
				<th>background</th>
				<th>foreground</th>
			</tr>
		</thead>
		<tbody id="tcolors"></tbody>
	</table></div>
	<p>colors are HSLa -- the 4th value (alpha) is optional</p>
	<p>Hue is degrees, Saturation and Luminosity is percent, Alpha is float 0..1, space is optional</p>
</div>
<div id="vday" class="modal">
	<a href="#" class="bcancel">《 Cancel</a>
	<!--
		https://ja.wikipedia.org/wiki/%E6%9B%9C%E6%97%A5
		1 月曜日 mon
		2 火曜日 tue
		3 水曜日 wed
		4 木曜日 thu
		5 金曜日 fri
		6 土曜日 sat
		7 日曜日 sun

		https://www.comiket.co.jp/index_e.html
		Dec 28,29,30,31 in 2019
		sat sun mon tue 土 日 月 火
	-->
	<a href="#" id="bmenu_day1">土 / 1</a>
	<a href="#" id="bmenu_day2">日 / 2</a>
	<!--a href="#" id="bmenu_day3">月 / 3</a>
	<a href="#" id="bmenu_day4">火 / 4</a-->
	<a href="#" id="dbg">debug</a>
</div>
<div id="vcirtype" class="modal">
	<a href="#" class="bcancel">《 Cancel</a>
	<a href="#" id="bmenu_cirkan">Sort by Kanji</a>
	<a href="#" id="bmenu_cirrom">Sort by Romaji</a>
</div>
<div id="vdl" class="modal">
	downloading database for day <span id="dl_day">N</span> ...<br /><br />
	<span id="dl_progress">N</span> done
</div>
<div id="vrowlist" class="modal">
	<a href="#" class="bcancel">《 Cancel</a>
	<div id="vrowlistb">
		<!-- will be populated with list of rows -->
	</div>
</div>
<div id="addctx" class="modal">
	<a href="#" class="bcancel">《 Cancel</a><a
	   href="#" id="badd_done">💯 Set "Purchased"</a><a
	   href="#" id="badd_urls">🔖 Manage <u>U</u>RLs</a><a
	   href="#" id="badd_rem">✘ Delete from list</a>

	<div id="addctxinf">
		<span id="ladd_kan">// kanji</span>
		<span id="ladd_loc">// location</span>
		<span id="ladd_rom">// romaji</span>
	</div>
	<table id="addctxsp"><tr>
		<td id="addctxpic"></td>
		<td id="addctxscore"></td>
	</tr></table>
	
	<div class="p50">
		<h3>navigate shopping list</h3>
		<div class="grid2"><a
			href="#" id="bgotoprevsel">previous</a><a
			href="#" id="bgotonextsel">nextious</a></div>
	</div><div class="p50">
		<h3>navigate booths</h3>
		<div class="grid2"><a
			href="#" id="bgotoprevday">previous</a><a
			href="#" id="bgotonextday">nextious</a></div>
	</div>

	<div id="addctxlinks"></div>
	<div id="addctxqnote">
		<input id="tqnote" placeholder="paste stuff here" />
		<a href="#" id="bqnote">Add URL/note</a>
	</div>
	<div class="center"><div id="addctx_exit_act">
		<input type="radio" name="addctx_exit_act" id="raddlist">
		<label for="raddlist">return to list</label><br />
		
		<input type="radio" name="addctx_exit_act" id="raddnext">
		<label for="raddnext">go to next booth</label><br />
		
		<label for="selskipmin">min. score</label>
		<input name="selskipmin" id="selskipmin" size="2" defval="1" />
	</div></div>
</div>
<div id="vexport" class="modal">
	<a href="#" class="bcancel">《 Cancel</a> <!-- ❮⫷ -->
	<p>select all the text below and copy it to some place safe, or...</p>
	<a href="#" id="export_download">💾 download export file</a>
	<textarea id="export_text" readonly></textarea>
</div>
<div id="vimport" class="modal">
	<a href="#" class="bcancel">《 Cancel</a> <!-- ❮⫷ -->
	<div class="center"><div>
		<input type="radio" name="rimport" id="rimport_drop" checked>
		<label for="rimport_drop">delete existing list</label><br />
		
		<input type="radio" name="rimport" id="rimport_repl" disabled>
		<label for="rimport_repl" class="notyet">merge; prefer imported</label><br />
		
		<input type="radio" name="rimport" id="rimport_curr" disabled>
		<label for="rimport_curr" class="notyet">merge; prefer current</label>
	</div></div>
	<p>paste your backup below and hit the text import button, or drop a backup file in the browser below</p>
	<input id="import_file" type="file" />
	<a href="#" id="bimport_text">📃 text import</a>
	<textarea id="timport_text"></textarea>
</div>
<div id="vdelc" class="modal">
	<a href="#" class="bcancel">《 Cancel</a>
	<div id="delinf">
		<span id="ldel_kan">// kanji</span>
		<span id="ldel_loc">// location</span>
		<span id="ldel_rom">// romaji</span>
	</div>
	<a href="#" id="bdel_yes">DELET</a>
</div>
<div id="vurls" class="modal">
	<a href="#" class="bcancel" invoke="open_addctx">《 Back</a>
	<a href="#" id="burl_new">💬 Add new</a> <!-- 🏵 -->
	<div id="vurls_list">
		<!-- will be the url list -->
	</div>
	click an entry to edit or remove
</div>
<div id="vurls_add" class="modal">
	<a href="#" class="bcancel" goto="vurls">《 Back</a>
	<input id="turl_add" />
	<a href="#" id="burl_add">Add this</a>
</div>
<div id="vurls_edit" class="modal">
	<a href="#" class="bcancel" goto="vurls">《 Back</a>
	<input id="turl_edit" />
	<a href="#" id="burl_edit">Save edit</a>
	<div id="lurl_cur"></div>
	<a href="#" id="burl_del"><u>D</u>elete</a>
</div>
<div id="vmaphall" class="modal">
	<!-- 東|123|456|西 -->
	<a href="#" class="bcancel">《 Cancel</a>
	<a href="#" id="bmaphall_e123">東123</a>
	<a href="#" id="bmaphall_e456">東456</a>
	<a href="#" id="bmaphall_w12">西12</a>
	<!--a href="#" id="bmaphall_w34">西34</a-->
	<a href="#" id="bzoom">zoom</a>
	<a href="#" id="bsave">save as image</a>
</div>
<div id="vzoom" class="modal">
	<a href="#" data-zoom="7">0.7x</a>
	<a href="#" data-zoom="10">1.0x</a>
	<a href="#" data-zoom="12">1.2x</a>
	<a href="#" data-zoom="15">1.5x</a>
	<a href="#" data-zoom="20">2.0x</a>
	<a href="#" data-zoom="25">2.5x</a>
	<a href="#" data-zoom="30">3.0x</a>
</div>

<div id="vpurgedb" class="modal">
	<p>could not write the database into localStore; it is probably full.</p>
	<p>delete the database of another day below by clicking it</p>
	<p>afterwards, another attempt will be made to save the day <span id="attempted_day">N</span> DB:</p>
	<div id="purgelist"></div>
	<p>--</p>
	<p>if nothing else works, you can try deleting absolutely everything including your shopping-list and all data from previous comikets:</p>
	<a href="#" id="purgeall">WIPE ALL DATA</a>
</div>
<div id="vsrchcfg" class="modal">
	<a href="#" class="bcancel" invoke="ev_tsch_input">《 Apply</a>
	<div>
		<input type="checkbox" id="csrch_regex" defval="0">
		<label for="csrch_regex">regex query</label><br />
		
		<input type="checkbox" id="csrch_name_kan" defval="1">
		<label for="csrch_name_kan">search name (kanji)</label><br />
		
		<input type="checkbox" id="csrch_name_rom" defval="1">
		<label for="csrch_name_rom">search name (romaji)</label><br />
		
		<input type="checkbox" id="csrch_loc" defval="1">
		<label for="csrch_loc">search location (カ04)</label><br />
		
		<input type="checkbox" id="csrch_url_all" defval="0">
		<label for="csrch_url_all">search URLs: All</label><br />
		
		<input type="checkbox" id="csrch_url_pixiv" defval="0">
		<label for="csrch_url_pixiv">search URLs: Pixiv</label><br />
		
		<input type="checkbox" id="csrch_url_twitter" defval="0">
		<label for="csrch_url_twitter">search URLs: Twitter</label><br />
	</div>
</div>
<div id="site">
	<div id="vtab">
		<table>
			<thead>
				<tr>
					<td>#</td> <!-- score -->
					<td>loc</td> <!-- day/row/col -->
					<td>kanji</td>
					<td>romaji</td>
				</tr>
			</thead>
			<tbody id="tb"></tbody>
		</table>
	</div>
	<div id="vmap" class="modal">
		<canvas id="map"></canvas>
	</div>
</div>
<script>
function hcroak(msg) {
	document.body.innerHTML = msg;
	window.onerror = undefined;
	throw 'fatal_err';
}
function croak(msg) {
	document.body.textContent = msg;
	window.onerror = undefined;
	throw msg;
}
function esc(txt) {
	return txt.replace(/[&"<>]/g, function(c) {
		return {
			'&': '&amp;',
			'"': '&quot;',
			'<': '&lt;',
			'>': '&gt;'
		}[c];
	});
}
window.onerror = function(msg, url, lineNo, columnNo, error) {
	window.onerror = undefined;
	var html = ['<h1>you hit a bug!</h1><p>please screenshot this error and send me a copy arigathanks gozaimuch (ed/irc.rizon.net or ed#2644)</p><p>',
		esc(String(msg)), '</p><p>', esc(url + ' @' + lineNo + ':' + columnNo), '</p>'];
	
	if (error) {
		var find = ['desc','stack','trace'];
		for (var a = 0; a < find.length; a++)
			if (String(error[find[a]]) !== 'undefined')
				html.push('<h2>' + find[a] + '</h2>' + 
					esc(String(error[find[a]])).replace(/\n/g, '<br />\n'));
	}
	document.body.style.fontSize = '0.8em';
	hcroak(html.join('\n'));
};

//function funcAlpha(v) { alertt(v); }
//function funcBeta(v) { funcAlpha(v); }
//funcBeta('fug');
</script>
<script src="lz-string.min.js"></script>
<script>

// だけど僕はそのままの

var DAYS = ['土', '日'];  //, '月', '火'];
var HALLS = ['e1','e2','e3','e4','e5','e6','w1a','w1b','w2a','w2b'];
var ROWS = [  // wall first, then right-to-left
	"ABCDEFGHIJKLM",  //e1
	"NOPQRSTUVWXY",  //e2
	"Zアイウエオカキクケコサ",  //e3
	"シスセソタチツテトナニヌネ",  //e6
	"ノハパヒピフプヘペホポマ",  //e5
	"ミムメモヤユヨラリルレロ",  //e4
	"あきくけこさしすせそたち",  //w2t
	"いうえおか",  //w2b
	"めつてとなにぬねのはひふ",  //w1t
	"へほまみむ"  //w1b
];

var BOOTHS = [];
var MAXNCOL = 0;
var active_day = -1;
var active_row;
var dbday = [];
var dbsel = [];
var lol = window.requestAnimationFrame.bind(window);
var render = null;  // fp
var empty_row_msg = '???';
var busted_localstore = false;
var pending_day_db = null;
var nfail = 0;
var sortkey1 = 'loc';
var sortkey2 = 'kan';
var active_tab = null;
var shitty_canvas_performance = false;  // TODO: set true for iOS


var ALLROWS = '';
for (var a = 0; a < ROWS.length; a++)
	ALLROWS += ROWS[a];


var DH = '0123456789';
var UH = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
var LH = 'abcdefghijklmnopqrstuvwxyz';
var DF = '０１２３４５６７８９';
var UF = 'ＡＢＣＤＥＦＧＨＩＪＫＬＭＮＯＰＱＲＳＴＵＶＷＸＹＺ';
var LF = 'ａｂｃｄｅｆｇｈｉｊｋｌｍｎｏｐｑｒｓｔｕｖｗｘｙｚ';

// hope this works
var RLOC = new RegExp(
	'([' + ALLROWS + UF + LF + '])[^' + ALLROWS + UH + LH + DH + DF + ']{0,3}([' +
	DH + DF + ']{1,2})[^' + ALLROWS + UH + LH + DH + DF + ']{0,1}([ABabＡＢａｂ]?)', 'u');


function tl(txt, from, to) {
	var re = new RegExp('[' + from + ']', 'gu');
	var dict = {};
	for (var a = 0; a < from.length; a++)
		dict[from[a]] = to[a];

	return txt.replace(re, function(c) {
		return dict[c];
	});
}


var ebi = document.getElementById.bind(document),
	QS = document.querySelector.bind(document),
	QSA = document.querySelectorAll.bind(document);

function ev(e) {
	if (e && e.preventDefault)
		e.preventDefault();
}


try {
	active_row = localStorage.getItem('activerow');
	if (active_row == null)
		active_row = 'Ａ';
}
catch(ex) {
	croak('could not read from localStorage; need this for the list of circles/booths');
}

try {
	localStorage.setItem('activerow', active_row);
}
catch(ex) {
	croak('could not write to localStorage; need this for the list of circles/booths');
}

var cc = function() {
	var r = {},
		cs = localStorage.getItem('bpc'),
		csd = [
			[  '0, 0%, 0%',         '90, 67%, 20%'],  // -
			[  '0, 0%, 100%, 0.2', '326, 100%, 23%'],  // 1
			[  '0, 0%, 100%, 0.1',   '0, 0%, 100%, 0.3'],  // 2
			[  '0, 0%, 100%, 0.1',   '0, 0%, 100%, 0.3'],  // 3
			[  '0, 0%, 100%, 0.1',   '0, 0%, 100%, 0.3'],  // 4
			['240, 20%, 20%',      '240, 20%, 40%'],  // 5
			[  '0, 40%, 30%',        '0, 40%, 50%'],  // 6
			[ '35, 70%, 30%',       '35, 70%, 50%'],  // 7
			[ '90, 70%, 30%',       '90, 70%, 50%'],  // 8
			['180, 70%, 40%',        '0, 0%, 100%'],  // 9
		];

	try {
		if (!cs)
			throw 1;

		cs = JSON.parse(cs);
	}
	catch (ex) {
		cs = JSON.parse(JSON.stringify(csd));
	}

	r.paint = function () {
		for (var a = 0; a < 10; a++) {
			var tr = QS(`#tcolors tr:nth-child(${a+1})`),
				tds = tr.getElementsByTagName('td'),
				rst = tr.getElementsByTagName('a')[0],
				ins = tr.getElementsByTagName('input'),
				tbg = ins[0],
				tfg = ins[1],
				bg = tbg.value || tbg.getAttribute('def'),
				fg = tfg.value || tfg.getAttribute('def');

			if (bg.split(/,/g).length < 4)
				bg += ', 1';

			if (fg.split(/,/g).length < 4)
				fg += ', 1';

			var cb = 'hsla(' + bg + ')',
				cf = 'hsla(' + fg + ')';

			tds[0].style.background = cb;
			tds[0].style.color = cf;
			(function(tbg, tfg) {
				rst.onclick = function(e) {
					ev(e);
					tbg.value = tbg.getAttribute('def');
					tfg.value = tfg.getAttribute('def');
					r.paint();
				};
				tbg.oninput = tfg.oninput = function(e) {
					r.paint();
				};
			})(tbg, tfg);

			cs[a] = [bg,fg];
			document.documentElement.style.setProperty('--b'+a, cb);
			document.documentElement.style.setProperty('--f'+a, cf);
			//alert(cb);
		}
		r.c = cs;
		r.b = ns(cs, 0);
		r.f = ns(cs, 1);
		localStorage.setItem('bpc', JSON.stringify(cs));
	};

	r.init = function (cs) {
		r.cs = cs;
		var html = [], css = [];
		for (var a = 0; a < 10; a++) {
			var c = cs[a], d = csd[a];
			html.push(`<tr>
				<td id="cn${a}">${a}</td>
				<td><input id="cb${a}" value="${c[0]}" def="${d[0]}" /></td>
				<td><input id="cf${a}" value="${c[1]}" def="${d[1]}" /></td>
				<td><a href="#" id="cr${a}">reset</a></td>
			</tr>`);
			css.push(`.sc${a}, .modal a.sc${a} {
				background: var(--b${a});
				color: var(--f${a});
			}`);
		}
		ebi('tcolors').innerHTML = html.join('');
		return css;
	};
	
	var cso = document.createElement('style');
	cso.innerHTML = r.init(cs).join('\n');
	cso.type = 'text/css';
	document.getElementsByTagName('head')[0].appendChild(cso);

	function ns(ca, n) {
		var ret = {}, t = [];
		for (var a = 0; a < 10; a++)
			t.push(ret[a?a+'':'-'] = 'hsla(' + ca[a][n] + ')');
		
		//alert(t.join('\n'));
		return ret;
	}

	r.paint();
	return r;
}();

var enpic;
setenpic(localStorage.getItem('enpic') != 'na');

var zoom;
setzoom(localStorage.getItem('zoom'));

var addctx_exit_act = localStorage.getItem('addctx_exit_act') || 'list';
if (addctx_exit_act == 'list')
	ebi('raddlist').checked = true;
else
	ebi('raddnext').checked = true;

function cfg_int(name, maxlen) {
	var obj = ebi(name);
	obj.value = tv;
	obj.setAttribute('maxlen', maxlen);
	var defval = obj.getAttribute('defval');
	
	var tv = localStorage.getItem(name) || defval;
	tv = parseInt(tv, 10);
	if (isNaN(tv)) tv = defval;
	window[name] = obj.value = tv;
	obj.oninput = ev_cfg_int_edit;
}
function ev_cfg_int_edit(e) {
	ev(e);
	var that = e.currentTarget;
	var name = that.getAttribute('id');
	var maxlen = parseInt(that.getAttribute('maxlen'), 10);
	var tv = that.value;
	if (tv.length > maxlen)
		tv = tv.slice(-maxlen);
	
	tv = parseInt(tv, 10);
	if (isNaN(tv) || String(tv).length < 1)
		tv = 0;
	
	that.value = tv;
	window[name] = tv;
	localStorage.setItem(name, tv);
}
function tint_bool(name, tv) {
	var objs = document.getElementsByTagName('label');
	for (var a = 0, aa = objs.length; a<aa; a++)
		if (objs[a].getAttribute('for') == name)
			objs[a].style.color = tv ? '#8d6' : '#d68';
}
function cfg_bool(name) {
	var obj = ebi(name);
	var tv = localStorage.getItem(name);
	if (tv !== '0' && tv !== '1')
		tv = obj.getAttribute('defval');
	
	tv = (tv === '1') ? true : false;
	window[name] = tv;
	obj.checked = tv;
	obj.oninput = ev_cfg_bool_edit;
	tint_bool(name, tv);
}
function ev_cfg_bool_edit(e) {
	ev(e);
	var that = e.currentTarget;
	var name = that.getAttribute('id');
	var tv = that.checked;
	window[name] = tv;
	localStorage.setItem(name, tv ? '1' : '0');
	tint_bool(name, tv);
}

var selskipmin;
cfg_int('selskipmin', '0', 1);

var csrch_opts = ebi('vsrchcfg').getElementsByTagName('input');
for (var a = 0, aa = csrch_opts.length; a < aa; a++) {
	var name = csrch_opts[a].getAttribute('id');
	window[name] = 'global variable construction 101';
	cfg_bool(name);
}



function tab(tid, skip_persist) {
	if (!skip_persist)
		persist_scroll();
	
	active_tab = tid;
	var tabs = ebi('topleft').getElementsByTagName('a');
	for (var a = 0; a < tabs.length; a++)
		tabs[a].classList.remove('act');
	
	try {
		ebi(tid).classList.add('act');
	}
	catch(ex) { }
}
function hidetoast(div) {
	if (div === undefined)
		div = this;
	
	if (div.currentTarget)
		div = div.currentTarget;
	
	//while (!div.classList.contains('toast') && div.parentNode)
	//	div = div.parentNode;
	
	if (div.parentNode !== null)
		div.parentNode.removeChild(div);
}
function nudgetoast(div) {
	div.classList.remove('nudged');
	if (div['bgcolor'])
		div.style.background = '#' + div['bgcolor'];
}
function toast(html, bgcolor) {
	var div = document.createElement('div');
	div.innerHTML = html;
	div.onclick = hidetoast;
	div.classList.add('toast');
	div.classList.add('nudged');
	if (bgcolor !== undefined)
		div['bgcolor'] = bgcolor;
	
	document.body.appendChild(div);
	setTimeout(function() { nudgetoast(div); }, 100);
	setTimeout(function() { hidetoast(div); }, 3000);
}
function toast_tab(tab, cname) {
	var ncells = 0;
	for (var a = 0; a < tab.length; a++)
		if (ncells < tab[a].length)
			ncells = tab[a].length;
	
	if (cname === undefined)
		html = ['<table>'];
	else
		html = ['<table class="' + cname + '">'];

	for (var a = 0; a < tab.length; a++)
	{
		html.push('<tr>');
		var len = tab[a].length;
		for (var b = 0; b < len; b++)
		{
			if (b == len - 1 && len < ncells)
				html.push('<td colspan="' +
					((ncells-len)+1) + '">' +
					tab[a][b] + '</td>');
			else
				html.push('<td>' + tab[a][b] + '</td>');
		}
		html.push('</tr>');
	}
	html.push('</table>');
	toast(html.join('\n'));
}
function locsort(a, b) {
	var la = a['loc'];
	var lb = b['loc'];
	
	var da = la.slice(0, 1);
	var db = lb.slice(0, 1);
	if (da < db) return -1;
	if (da > db) return -1;
	
	var ha = la.slice(2, 3);
	var hb = lb.slice(2, 3);
	if (ha === hb)
		return la.localeCompare(lb);
	
	var nha = ALLROWS.indexOf(ha);
	var nhb = ALLROWS.indexOf(hb);
	if (nha < nhb) return -1;
	if (nha > nhb) return 1;
	return 0;
}
function push_file(filename, text) {
  var elm = document.createElement('a');
  elm.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  elm.setAttribute('download', filename);

  elm.style.display = 'none';
  document.body.appendChild(elm);

  elm.click();

  document.body.removeChild(elm);
}
function iso8601ish() {
	var pad = function(num) {
		if (num < 10)
			return '0' + num;
		return num;
	};
	var d = new Date();
	return d.getUTCFullYear() + '-' +
		pad(d.getUTCMonth() + 1) +
		pad(d.getUTCDate()) + '-' +
		pad(d.getUTCHours()) +
		pad(d.getUTCMinutes()) +
		pad(d.getUTCSeconds());
}


var html = [];
for (var a = 0; a < ROWS.length; a++) {
	html.push('<span>' + HALLS[a] + '</span>');
	for (var b = 0; b < ROWS[a].length; b++)
		html.push('<a href="#">' + ROWS[a][b] + '</a>');
	html.push('<hr />');
}
ebi('vrowlistb').innerHTML = html.join('\n');

var links = ebi('vrowlistb').getElementsByTagName('a');
for (var a = 0, aa = links.length; a<aa; a++)
	links[a].onclick = ev_jumprow;

var html = [];
for (var a = 1; a < 10; a++)
{
	html.push('<a href="#" class="sc' + a + '" id="badd_r' + a + '">' + a + '</a>');
	if (a % 3 == 0)
		html.push('<br />');
}
ebi('addctxscore').innerHTML = html.join('');
var links = ebi('addctxscore').getElementsByTagName('a');
for (var a = 0, aa = links.length; a<aa; a++)
	links[a].onclick = ev_score;

function hide_modals(e) {
	ev(e);
	var modals = QSA('.modal');
	for (var a = 0, aa = modals.length; a<aa; a++)
		modals[a].style.display = 'none';
	
	show('vtab');
}
function hide_viewctls(e) {
	ev(e);
	var modals = QSA('.viewctl');
	for (var a = 0, aa = modals.length; a<aa; a++)
		modals[a].style.display = 'none';
	
	ev_resize();
}
function show(html_id) {
	ebi(html_id).style.display = 'block';
	if (scroll_obj)
		scroll_obj.scrollTop = 0;
}
function show_excl(html_id) {
	persist_scroll();
	hide_modals();
	vtab.style.display = 'none';
	show(html_id);
}
function show_menu(e) {
	ev(e);
	hide_modals();
	show_excl('vmenu');
}
function ev_cfg(e) {
	ev(e);
	hide_modals();
	show_excl('vcfg');
}
function ev_cfg_colors(e) {
	ev(e);
	hide_modals();
	show_excl('vcolors');
}
function show_chday(e) {
	ev(e);
	hide_modals();
	show_excl('vday');
}
function isvis(html_id) {
	return ebi(html_id).style.display == 'block';
}
function ev_chday(e) {
	ev(e);
	hide_modals();
	var words = this.innerHTML.split(' ');
	var nday = parseInt(words[words.length-1], 10);
	inf(['unpacking day ' + nday]);
	lol(function() { lol(function() {
		load_day(nday);
	})});
}
function err_no_data() {
	warn([
		"<strong>== Day " + active_day + " database not downloaded ==</strong>",
		"Use the menu button top right;",
		"optionally change to another day first,",
		"then press «<u>Download DB</u>» to continue"
	]);
}
function load_day(day) {
	var loaded;
	
	if (day === undefined)
	{
		loaded = localStorage.getItem('activeday');
		if (loaded == null)
			active_day = 2;
		else
			active_day = parseInt(loaded, 10);
	}
	else
		active_day = day;
	
	dbday = [];
	localStorage.setItem('activeday', active_day);
	ebi('bmenu_day').innerHTML = '📆 Change day (now: ' + active_day + ')';
	ebi('bmenu_dload').innerHTML = '📲 Download DB for Day ' + active_day;
	
	loaded = localStorage.getItem('z101day' + active_day);
	if (loaded == null) {
		err_no_data();
		return false;
	}
	
	try {
		loaded = LZString.decompressFromUTF16(loaded);
	}
	catch (ex) {
		loaded = '[]';
		alert('failed to unpack the circle/booth database; you will still be able to export your JSON while I figure out what went wrong (sorry)');
	}
	
	dbday = JSON.parse(loaded);
	
	MAXNCOL = 0;
	for (var a = 0; a < ALLROWS.length; a++)
	{
		var ncols = 0;
		for (var b = 0, bb = dbday.length; b<bb; b++) {
			var rday = dbday[b]['loc'].slice(0, 1);
			var rrow = dbday[b]['loc'].slice(2, 3);
			
			if (rday != active_day) continue;
			if (rrow != ALLROWS[a]) continue;
			
			ncols++;
		}
		if (MAXNCOL < ncols)
			MAXNCOL = ncols;
	}

	for (var a = 0, aa = dbday.length; a<aa; a++)
		dbday[a]['kar'] = dbday[a]['kan'] + ' ' +
			tl(dbday[a]['kan'], UF+LF+DF, LH+LH+LH);

	load_sel();

	if (active_day == 2) {
		var ds = {'1': [], '2': []}
		for (var a = 0; a < dbsel.length; a++) {
			var d = dbsel[a].loc[0];
			ds[d].push(dbsel[a]);
		}
		if (ds['1'].length)
			fix_day2(ds);
	}

	ev_added();
}
function load_sel() {
	loaded = localStorage.getItem('z101sel' + active_day);
	if (loaded == null) {
		dbsel = [];
		inf([
			"<strong>== Loaded day " + active_day + " ==</strong>",
			"Start adding some booths:",
			"Select «<u>Show all booths</u>» in the menu"
		]);
		return true;
	}

	try {
		loaded = LZString.decompressFromUTF16(loaded);
	}
	catch (ex) {
		croak('failed to unpack your shopping list database (fuck)');
	}
	
	dbsel = JSON.parse(loaded);
	return true;
}
function save_sel() {
	try {
		var jsontxt = JSON.stringify(dbsel);
		var packed = LZString.compressToUTF16(jsontxt);
		localStorage.setItem('z101sel' + active_day, packed);
	}
	catch (ex) {
		busted_localstore = true;
		alert("could not save your shopping list! you can rescue day " + active_day + " with the export feature until you refresh the website.\n\n(is your localStorage full?)");
	}
}
function fix_day2(ds) {
	// first version of c101 day2 also included day2 booths; transfer any ratings to day1
	dbsel = ds['2'];
	save_sel();
	active_day = 1;
	load_sel();
	var v = ds['1'];
	for (var a = 0; a < v.length; a++) {
		var found = false;
		for (var b = 0; b < dbsel.length; b++)
			if (dbsel[b].loc == v[a].loc)
				found = true;
		if (!found)
			dbsel.push(v[a]);
	}
	save_sel();
	active_day = 2;
	load_sel();
}
function showmsg(color, lines) {
	var s1 = '<tr><td colspan="4" style="color:#' + color + '">';
	var s2 = '</td></tr>';
	lines.unshift('&nbsp;');
	ebi('tb').innerHTML = s1 + lines.join(s2+s1) + s2;
	hide_modals();
	hide_viewctls();
}
function err(lines)  { showmsg('f75', lines); }
function warn(lines) { showmsg('fc0', lines); }
function inf(lines)  { showmsg('ad6', lines); }


function put_day_db(jsontxt) {
	ebi('purgeall').onclick = null;

	if (jsontxt !== undefined)
		pending_day_db = LZString.compressToUTF16(jsontxt);
	
	try {
		if (nfail-- > 0) throw 42;
		localStorage.removeItem('day' + active_day);
		localStorage.removeItem('zday' + active_day);
		localStorage.setItem('z101day' + active_day, pending_day_db);
	}
	catch (ex) {
		full_localstore();
		return false;
	}
	load_day();
	
	return true;
}
function dl_done(v) {
	if (this.status != 200)
	{
		alert('** ERROR ' + this.status + ' FROM SERVER **\n\n' + this.responseText);
		return;
	}

	inf(['compressing database']);
	var jsontxt = this.responseText;
	lol(function() { lol(function() {
		put_day_db(jsontxt);
	})});
}
function dl_error() {
	alert('error downloading db from server');
}
function dl_progress(e) {
	var progress = '???';
	if (e.lengthComputable)
		progress = Math.round(e.loaded / e.total * 100) + '%';
	else
		try {
			progress = Math.round(e.loaded / 1024) + ' KiB';
		}
		catch(ex) { }

	ebi('dl_progress').innerHTML = progress;
}
function ev_dload() {
	var url = 'lkrxy' + active_day + '.json?_=' + Date.now();
	var req = new XMLHttpRequest();
	req.onload = dl_done;
	req.onerror = dl_error;
	req.onprogress = dl_progress;
	req.open('GET', url, true);
	req.send();

	ebi('dl_day').innerHTML = active_day;
	ebi('dl_progress').innerHTML = '0';
	hide_modals();
	show('vdl');
}

var scroll_obj = null;
var scroll_pos = [0,0];
var scroll_booth = null;
function get_scroll_offset() {
	var o1 = document.getElementsByTagName('html')[0];
	var o2 = document.body;
	
	var obj = o1.scrollTop > o2.scrollTop ? o1 : o2;
	var ret = obj.scrollTop;
	
	if (ret > 0)
		scroll_obj = obj;
	
	return ret;
}
function persist_scroll() {
	var vtab = ebi('vtab');
	if (vtab.style.display === 'none')
		return;
	
	var idx =
		active_tab == 'tbmenu_chk' ? 0 :
		active_tab == 'tbmenu_row' ? 1 : -1;
	
	if (idx < 0)
		return;

	if (scroll_obj !== null) {
		scroll_pos[idx] = scroll_obj.scrollTop;
		return;
	}
	
	scroll_pos[idx] = get_scroll_offset();
}
function restore_scroll(new_view) {
	var idx =
		active_tab == 'tbmenu_chk' ? 0 :
		active_tab == 'tbmenu_row' ? 1 : -1;
	
	if (idx < 0)
		return;

	try {
		if (!new_view)
			throw 1;
		
		var ofs = scroll_pos[idx],
			el = ebi('c' + scroll_booth);

		scroll_booth = null;
		
		if (ofs)
			scroll_obj.scrollTop = ofs;
		else
			el.scrollIntoView();

		el.classList.add('hil');
		setTimeout(function() {el.classList.remove('hil')}, 1000);
	}
	catch (ex) {}
}

function refresh() {
	//var t = document.getElementsByTagName('*'); for (var a=0, aa=t.length; a<aa; a++) if (t[a].scrollTop > 0) alert(t[a].scrollTop + ' for ' + t[a].tagName + ' / ' + t[a].id);
	render();
	
	lol(function() { lol(function() {
		restore_scroll();
	})});
}
function ev_cir(sortfunc, only_faved) {
	inf(['drawing UI']);
	lol(function() { lol(function() {
		var html = [];
		empty_row_msg = 'nothing to display in this list';
		BOOTHS = JSON.parse(JSON.stringify(dbday));
		BOOTHS.sort(sortfunc);
		draw_tbody(only_faved);
	})});
}
function ev_cirkan() {
	hide_viewctls();
	render = function() {
	};
	ev_cir((a,b) => (a.kan.localeCompare(b.kan)), false);
}
function ev_cirrom() {
	hide_viewctls();
	render = function() {
	};
	ev_cir((a,b) => (a.rom.localeCompare(b.rom)), false);
}
function ev_row(e) {
	ev(e);
	render = function() {
		hide_modals();
		hide_viewctls();
		tab('tbmenu_row', true);
		show('tabh_row');
		show('tabh_col');
		show('tabh_txt');
		goto_row(active_row);
	};
	default_intxt_if_box('trow_in', 'tabh_txt');
	render();
}
function ev_cirtype() {
	//inf(['window cleared for performance reasons']);
	hide_modals();
	show('vcirtype');
}
function ev_listrows() {
	hide_modals();
	show_excl('vrowlist');
}
function ev_jumprow(e) {
	ev(e);
	// todo: oop views
	scroll_pos[1] = 0;
	if (scroll_obj !== null)
		scroll_obj.scrollTop = 0;
	
	goto_row(this.innerHTML);
}
function goto_row(row) {
	hide_modals();
	active_row = row;
	localStorage.setItem('activerow', active_row);
	
	var ridx = ALLROWS.indexOf(row);
	
	if (ridx == 0) {
		ebi('brow_prev').classList.add('off');
		ebi('brow_prev').innerHTML = '🙅';
	}
	else {
		ebi('brow_prev').classList.remove('off');
		ebi('brow_prev').innerHTML = ALLROWS[ridx-1];
	}
	
	if (ridx > ALLROWS.length - 2) {
		ebi('brow_next').classList.add('off');
		ebi('brow_next').innerHTML = '🙅';
	}
	else {
		ebi('brow_next').classList.remove('off');
		ebi('brow_next').innerHTML = ALLROWS[ridx+1];
	}
	
	BOOTHS = [];
	for (var a = 0, aa = dbday.length; a<aa; a++) {
		var rday = dbday[a]['loc'].slice(0, 1);
		var rrow = dbday[a]['loc'].slice(2, 3);
		
		if (rday != active_day) continue;
		if (rrow != row) continue;
		
		//BOOTHS.push(dbday[a]['loc'].slice(3));
		BOOTHS.push(dbday[a]);
	}
	
	// should be safe since everything until the int is identical
	BOOTHS.sort((a,b) => (a.loc.localeCompare(b.loc)));
	
	empty_row_msg = 'row ' + row + ' empty on day ' + active_day;
	draw_tbody(false);

	ev_resize();
	draw_th();
}
function draw_tbody(only_faved) {
	var html = [];
	for (var a = 0, aa = BOOTHS.length; a<aa; a++)
	{
		var loc = BOOTHS[a]['loc'];
		var isdone = false;
		var score = '-';
		for (var b = 0, bb = dbsel.length; b<bb; b++)
			if (loc == dbsel[b]['loc'])
			{
				score = dbsel[b]['sc'];
				if (dbsel[b]['done'])
					isdone = true;
				
				break;
			}
		
		if (only_faved && score === '-')
			continue;
		
		var trclass = "sc" + score;
		if (isdone)
			trclass += ' done';
		
		//var ypos = loc.slice(3);
		html.push('<tr id="c' +
			loc + '" act="ev_rowclick" + class="' +
			trclass + '"><td>' +
			score + '</td><td>' +
			BOOTHS[a]['loc'] + '</td><td>' +
			esc(BOOTHS[a]['kan']) + '</td><td>' +
			esc(BOOTHS[a]['rom']) + '</td></tr>');
	}
	
	if (html.length == 0)
	{
		if (dbday.length == 0)
			return err_no_data();

		html.push('<tr><td colspan="4">' +
			empty_row_msg + '</td></tr>');
	}
	
	ebi('tb').innerHTML = html.join('\n');
	
	var rows = ebi('tb').getElementsByTagName('tr');
	for (var a = 0, aa = rows.length; a<aa; a++)
	{
		rows[a].onmousedown = ev_mousedown;
		rows[a].onmouseup = ev_mouseup;
	}
	draw_th();
	lol(function() { lol(function() {
		restore_scroll();
	})});
}
function draw_th() {
	var co = ebi('tabh_col');
	if (co.style.display == 'none')
		return;
	
	var width =
		parseInt(getComputedStyle(co)['width'], 10) /
		parseFloat(getComputedStyle(co)['font-size']);
	
	//var step = Math.ceil(BOOTHS.length / (width/3.5));
	var free = Math.floor(width/3.5);
	var step = Math.ceil(MAXNCOL / free);
	if (step < 1)
		step = 1;
	
	var html = [];
	for (var a = 0; a < BOOTHS.length; a += step)
	{
		var sbooth = BOOTHS[a]['loc'].slice(3);
		
		// please don't look
		var ypos = parseInt(sbooth.slice(3, 5), 10);
		if (ypos > 3)
			ypos -= 3;
		
		var scrpos = '00' + ypos;
		scrpos = scrpos.slice(-2);
		scrpos = sbooth.slice(0, 3) + scrpos + sbooth.slice(5);
		// it's ok now
		
		if (a == 0)
			html.push('<a href="#">' + sbooth + '</a>');
		else
			html.push('<a href="#c' + scrpos + '">' + sbooth + '</a>');
	}
	co.innerHTML = html.join('');
}
function ev_steprow() {
	if (this.classList.contains('off'))
		return;
	
	// todo: oop views
	scroll_pos[1] = 0;
	if (scroll_obj !== null)
		scroll_obj.scrollTop = 0;
	
	goto_row(this.innerHTML);
}
function tb_fields(tgt) {
	var tds = tgt.getElementsByTagName('td');
	return {
		"score": tds[0].textContent,
		"loc": tds[1].textContent,
		"kanji": tds[2].textContent,
		"romaji": tds[3].textContent
	};
}
function get_ibooth(loc) {
	if (loc === undefined)
		loc = ebi('ladd_loc').textContent;
	
	for (var a = 0, aa = BOOTHS.length; a < aa; a++)
		if (loc == BOOTHS[a]['loc'])
			return a;
	
	return -1;
}
function get_tbooth(loc) {
	var idx = get_ibooth(loc);
	if (idx < 0)
		return null;
	
	return BOOTHS[idx];
}
function get_iday(loc) {
	if (loc === undefined)
		loc = ebi('ladd_loc').textContent;
	
	for (var a = 0, aa = dbday.length; a < aa; a++)
		if (loc == dbday[a]['loc'])
			return a;
	
	return -1;
}
function get_tday(loc) {
	var idx = get_iday(loc);
	if (idx < 0)
		return null;
	
	return dbday[idx];
}
function get_tsel(loc, create_if_404) {
	for (var a = 0, aa = dbsel.length; a < aa; a++)
		if (loc == dbsel[a]['loc'])
			return dbsel[a];
	
	if (!create_if_404)
		return null;
	
	set_score(loc, '-');
	return get_tsel(loc);
}
function ev_rowclick(e, tgt) {
	ev(e);
	var loc = tb_fields(tgt)['loc'];
	open_addctx(loc);
}
function set_score(loc, score) {
	for (var a = 0, aa = dbsel.length; a < aa; a++)
		if (dbsel[a]['loc'] == loc)
		{
			dbsel[a]['sc'] = score;
			save_sel();
			return true;
		}
	
	dbsel.push({
		'loc': loc,
		'sc': score
	});
	save_sel();
}
function ev_score(e) {
	ev(e);
	var loc = ebi('ladd_loc').textContent;
	var score = this.textContent;
	
	set_score(loc, score);
	hide_modals();
	toast_tab([
		['score', score],
		['loc', loc],
		[ebi('ladd_kan').textContent],
		[ebi('ladd_rom').textContent]
	], 'sc' + score);
	refresh();
	
	if (addctx_exit_act == 'next') {
		var nextbooth = get_next_booth();
		if (!nextbooth)
			return alert('no more booths in this row');
		
		open_addctx(nextbooth);
	}
}
function ev_added() {
	hide_viewctls();
	tab('tbmenu_chk');
	render = function() {
		ev_cir(locsort, true);
		show('added_inf');
		show('added_jump');
		
		var have = 0;
		var todo = 0;
		var scorekeys = ['-'];
		for (var a = 1; a < 10; a++)
			scorekeys.push(a);
		
		var scores = {};
		for (var a = 0; a < scorekeys.length; a++)
			scores[scorekeys[a]] = 0;
		
		for (var a = 0; a < dbsel.length; a++) {
			if (dbsel[a]['done'])
				have++;
			else {
				todo++;
				scores[dbsel[a]['sc']]++;
			}
		}
		
		var html = [];
		html.push('<span>done</span>' + have);
		html.push('<span>todo</span>' + todo);
		
		for (var a = 0; a < scorekeys.length; a++)
			html.push('<span>' + scorekeys[a] + '</span>' + scores[scorekeys[a]]);
		
		ebi('added_inf').innerHTML = html.join(' ');
		
		html = [];
		have = 0;
		todo = 0;
		var last_row = null;
		var first_in_row = null;
		for (var a = 0, aa = dbsel.length; a<aa; a++) {
			var loc = dbsel[a]['loc'];
			var row = loc.slice(2, 3);
			if (last_row != row) {
				if (todo > 0)
					html.push('<a href="#c' + first_in_row + '">' + last_row + '</a>' + todo);
				have = 0;
				todo = 0;
				last_row = row;
				first_in_row = loc;
			}
			
			if (dbsel[a]['done'])
				have++;
			else if (dbsel[a]['sc'] >= 5)
				todo++;
			
			if (a == aa-1)  // :shrug:
				if (todo > 0)
					html.push('<a href="#c' + first_in_row + '">' + last_row + '</a>' + todo);
		}
		ebi('added_jump').innerHTML = html.join(' ');
		
		var links = ebi('added_jump').getElementsByTagName('a');
		for (var a = 0; a < links.length; a++)
			links[a].onclick = ev_scrollto;
		
		ev_resize();
	};
	render();
}
function ev_focus(e) {
	var sample = this.getAttribute('sample');
	if (this.value == sample)
		this.value = '';
}
function ev_blur(e) {
	var sample = this.getAttribute('sample');
	if (this.value == '')
		this.value = sample;
}
function ev_import(e) {
	ev(e);
	hide_modals();
	ebi('import_file').value = '';
	show_excl('vimport');
}
function ev_export(e) {
	ev(e);
	ebi('export_text').value = gen_export();
	hide_modals();
	show_excl('vexport');
}
function gen_export() {
	var ret = {};
	for (var a = 1; a <= 4; a++) {
		try {
			var kt = localStorage.getItem('z101sel'+a);
			if (kt != null) {
				var unpacked = LZString.decompressFromUTF16(kt);
				ret['c101sel'+a] = JSON.parse(unpacked);
			}
		}
		catch(ex) {
			alert('failed to export selection db ' + a);
		}
	}
	if (busted_localstore) {
		alert('emergency export of day ' + active_day + ' in effect');
		ret['c101sel'+active_day] = dbsel;
	}
	for (var a = 1; a <= 4; a++) {
		if (!ret['c101sel'+a])
			continue;

		ret['c101sel'+a].sort(locsort);
	}

	try {
		ret['colors'] = JSON.parse(localStorage.getItem('bpc').replace(/ /g,''));
	}
	catch (ex) {}

	return JSON.stringify(ret
		).replace(/{"loc":"/g, '\n{"loc":"'
		).replace(/}],"/g, '}],\n"'
		);
}
function ev_export_file(e) {
	ev(e);
	var txt = gen_export();
	push_file("battleplan-" + iso8601ish() + ".json", txt);
}
function json_err(ex, txt) {
	var msg = [String(ex),'here is your json with each line prefixed with numLine:numGlyph'];
	var ofs = 0;
	txt = txt.split('\n');
	for (var a = 0; a < txt.length; a++) {
		msg.push('<span style="color:#c09">' + (a+1) + ':' + ofs + '</span> ' + esc(txt[a]));
		ofs += txt[a].length;
	}
	err(msg);
}
function import_text(txt) {
	//alert(txt);
	inf(['data is now importing', 'please watch warmly']);
	lol(function() { lol(function() {
		var iv;
		try {
			iv = JSON.parse(txt);
		}
		catch(ex) {
			json_err(ex, txt);
			return;
		}
		for (var a = 1; a <= 4; a++) {
			var uk = 'c101sel' + a;
			var ck = 'z101sel' + a;
			localStorage.removeItem(uk);
			localStorage.removeItem(ck);
			if (iv[uk]) {
				var jsonstr = JSON.stringify(iv[uk]);
				var packed = LZString.compressToUTF16(jsonstr);
				localStorage.setItem(ck, packed);
			}
		};

		try {
			localStorage.setItem('bpc', JSON.stringify(iv.colors).replace(/ /g,'').replace(/,/,', '));
			cc.init(iv.colors);
			cc.paint();
		}
		catch (ex) {}

		load_day(active_day);
	})});
}
function ev_import_file(e) {
	const file = this.files.item(0);
	const reader = new FileReader();
	reader.readAsText(file);
	reader.onload = function(e2) {
		import_text(reader.result);
	};
}
function ev_import_text(e) {
	ev(e);
	import_text(ebi('timport_text').value);
}
function ev_purchased(e) {
	var loc = ebi('ladd_loc').textContent;
	var entry = get_tsel(loc, true);
	
	var desc = ebi('ladd_loc').textContent + '<br />' +
		ebi('ladd_kan').textContent + '<br />' +
		ebi('ladd_rom').textContent;
	
	if (entry['done'])
	{
		delete entry['done'];
		toast('NEED TO BUY ' + desc, '642');
	}
	else {
		entry['done'] = 1;
		toast('Purchased ' + desc, '472');
	}
	save_sel();
	refresh();
}
function ev_remove(e) {
	ev(e);
	ebi('ldel_kan').textContent = ebi('ladd_kan').textContent;
	ebi('ldel_rom').textContent = ebi('ladd_rom').textContent;
	ebi('ldel_loc').textContent = ebi('ladd_loc').textContent;
	
	hide_modals();
	show_excl('vdelc');
}
function ev_remove_ok(e) {
	ev(e);
	var find = ebi('ldel_loc').textContent;
	var rmlist = dbsel.filter(o => {
		return o.loc === find;
	});
	if (rmlist.length !== 1) {
		alert('cant delete, expected 1 but got ' + rmlist.length);
		return;
	}
	dbsel.splice(dbsel.indexOf(rmlist[0]), 1);
	
	save_sel();
	refresh();
	hide_modals();
}
function ev_mousedown(e) {
	if (e.button > 1)
		return;
	
	e.currentTarget.mdt = Date.now();
}
function ev_mouseup(e) {
	if (e.button > 1)
		return;
	
	var now = Date.now();
	var tgt = e.currentTarget;
	if (now - parseFloat(tgt.mdt) < 200)
		lol(function() { lol(function() {
			var fn = tgt.getAttribute('act');
			if (window[fn])
				window[fn](e, tgt);
			else
				console.log('undefined function: ' + fn);
		})});
}
function default_intxt_if_box(intxt, box) {
	if (box === undefined)
		box = intxt;
	
	if (ebi(box).style.display == 'block') {
		var box = ebi(intxt);
		box.value = box.getAttribute('sample');
	}
}
function ev_srch(e) {
	ev(e);
	default_intxt_if_box('tsrch');
	hide_modals();
	hide_viewctls();
	show('tsrch');
	show('srchinfb');
	tab('tbmenu_srch');
	ebi('srchinf').innerHTML = 'Search for a circle above';
	
	lol(function() { lol(function() {
		ev_tsch_input();
	})});
}
function ev_tsch_input(e) {
	ev(e);
	var txt = ebi('tsrch').value.toLowerCase();
	
	if (csrch_regex) {
		var re = new RegExp(txt, 'u');
		BOOTHS = dbday.filter(o => {
			if (csrch_name_kan && re.exec(o.kar.toLowerCase()))
				return true;
			
			if (csrch_name_rom && re.exec(o.rom.toLowerCase()))
				return true;
			
			if (csrch_loc && re.exec(o.loc.toLowerCase()))
				return true;
			
			if (o.url)
				for (var a = 0; a < o.url.length; a++) {
					var lcu = o.url[a].toLowerCase();
					if (!re.exec(lcu))
						continue;
					
					if (csrch_url_all)
						return true;
					
					if (csrch_url_pixiv && lcu.indexOf('pixiv.') !== -1)
						return true;
					
					if (csrch_url_twitter && lcu.indexOf('twitter.') !== -1)
						return true;
				}
			
			return false;
		});
	}
	else {
		BOOTHS = dbday.filter(o => {
			if (csrch_name_kan && o.kar.toLowerCase().indexOf(txt) !== -1)
				return true;
			
			if (csrch_name_rom && o.rom.toLowerCase().indexOf(txt) !== -1)
				return true;
			
			if (csrch_loc && o.loc.toLowerCase().indexOf(txt) !== -1)
				return true;
			
			if (o.url)
				for (var a = 0; a < o.url.length; a++) {
					var lcu = o.url[a].toLowerCase();
					if (lcu.indexOf(txt) === -1)
						continue;
					
					if (csrch_url_all)
						return true;
					
					if (csrch_url_pixiv && lcu.indexOf('pixiv.') !== -1)
						return true;
					
					if (csrch_url_twitter && lcu.indexOf('twitter.') !== -1)
						return true;
				}
			
			return false;
		});
	}
	BOOTHS.sort(locsort);
	
	var info = BOOTHS.length + ' results';
	if (BOOTHS.length > 100) {
		BOOTHS.splice(100, 999999);
		info = 'Over 100 results';
	}
	ebi('srchinf').textContent = info;
	
	render = function() {
		empty_row_msg = 'no search results';
		draw_tbody(false);
	};
	render();
	ev_resize();
}
function ev_trowin_input(e) {
	ev(e);
	BOOTHS = [];
	
	var txt = ebi('trow_in').value;
	txt = txt.replace(/ブロック/gu, '');
	var m = RLOC.exec(txt);
	if (!m) {
		ebi('trow_out').value = 'bad syntax';
	}
	else {
		// var DH = '0123456789';
		// var UH = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
		// var LH = 'abcdefghijklmnopqrstuvwxyz';
		// var DF = '０１２３４５６７８９';
		// var UF = 'ＡＢＣＤＥＦＧＨＩＪＫＬＭＮＯＰＱＲＳＴＵＶＷＸＹＺ';
		// var LF = 'ａｂｃｄｅｆｇｈｉｊｋｌｍｎｏｐｑｒｓｔｕｖｗｘｙｚ';
		
		var find =
			tl(m[1], LH+LF+UF, UH+UH+UH) +
			tl(m[2], DF, DH) +
			tl(m[3], UH+UF+LF, LH+LH+LH);
		
		ebi('trow_out').value = find;
		
		BOOTHS = dbday.filter(o => {
			return o['loc'].indexOf(find) !== -1;
		});
		BOOTHS.sort(locsort);
	}
	
	render = function() {
		empty_row_msg = 'no search results';
		draw_tbody(false);
	};
	render();
}
function ev_urls(e) {
	ev(e);
	var loc = ebi('ladd_loc').textContent;
	var tsel = get_tsel(loc, true);
	if (tsel == null) {
		alert('error reading tsel for [' + loc + ']');
		return;
	}
	var html = [];
	if (tsel['url'])
		for (var a = 0; a < tsel['url'].length; a++)
			html.push('<a href="#">' + esc(tsel['url'][a]) + '</a>');
	
	ebi('vurls_list').innerHTML = html.join('\n');
	var links = ebi('vurls_list').getElementsByTagName('a');
	for (var a = 0; a < links.length; a++)
		links[a].onclick = ev_url_mod;

	hide_modals();
	show_excl('vurls');
}
function ev_url_new(e) {
	ev(e);
	hide_modals();
	ebi('turl_add').value = '';
	show('vurls_add');
}
function add_url(loc, txt) {
	var tsel = get_tsel(loc, true);
	
	if (!tsel['url']) {
		tsel['url'] = [txt];
	}
	else {
		for (var a = 0; a < tsel['url'].length; a++) {
			if (tsel['url'][a] == txt) {
				alert('that url already exists');
				return false;
			}
		}
		tsel['url'].push(txt);
	}
	
	save_sel();
	return true;
}
function ev_url_new_done(e) {
	ev(e);
	var txt = ebi('turl_add').value;
	var loc = ebi('ladd_loc').textContent;
	add_url(loc, txt);
	ev_urls();
}
function ev_url_mod(e) {
	ev(e);
	var txt = this.textContent;
	ebi('turl_edit').value = txt;
	ebi('lurl_cur').textContent = txt;
	
	hide_modals();
	show('vurls_edit');
}
function ev_url_edit_save(e) {
	ev(e);
	var orig = ebi('lurl_cur').textContent;
	var repl = ebi('turl_edit').value;
	
	if (orig == repl) {
		alert('new url is identical to the previous value; aborting');
		return;
	}
	
	var loc = ebi('ladd_loc').textContent;
	var tsel = get_tsel(loc, true);
	for (var a = 0; a < tsel.url.length; a++)
		if (tsel.url[a] == repl) {
			alert('new url already exists in the list; aborting');
			return;
		}
	
	for (var a = 0; a < tsel.url.length; a++)
		if (tsel.url[a] == orig) {
			tsel.url[a] = repl;
			save_sel();
			ev_urls();
			return;
		}
	
	alert('could not find url [' + orig + ']\nwas going to replace with [' + repl + ']');
}
function ev_url_delete(e) {
	ev(e);
	var orig = ebi('lurl_cur').textContent;
	var loc = ebi('ladd_loc').textContent;
	var tsel = get_tsel(loc, true);
	var idx = -1;
	for (var a = 0; a < tsel.url.length; a++)
		if (tsel.url[a] == orig)
			idx = a;
	
	if (idx < 0) {
		alert('cold not find url [' + orig + '] ?? panic');
		return;
	}
	tsel.url.splice(idx, 1);
	
	save_sel();
	ev_urls();
}
function full_localstore() {
	var html = [];
	var keys = ['z101day1','z101day2']; //,'z101day3','z101day4'];
	for (var a = 0; a < keys.length; a++)
		try {
			var len = localStorage.getItem(keys[a]).length;
			var trait = 'uncompressed';
			if (keys[a].indexOf('z') == 0)
				trait = '';
			
			html.push('<a href="#" skey="' + keys[a] + '">' + trait + ' day ' + keys[a].slice(keys[a].length-1) + ' (' + Math.round(len/1024) + ' KiB)</a>');
		}
		catch(ex) { }
	
	if (html.length == 0)
		html.push('<h1>actually nevermind you broke it</h1><p>check if your disk is full i guess</p>');
	
	ebi('purgelist').innerHTML = html.join('\n');
	ebi('attempted_day').innerHTML = active_day;
	var links = ebi('purgelist').getElementsByTagName('a');
	for (var a = 0; a < links.length; a++)
		links[a].onclick = ev_purge_day;
	
	hide_modals();
	show('vpurgedb');
	ebi('purgeall').onclick = ev_purge_all;
}
function ev_purge_day(e) {
	ebi('purgelist').innerHTML = '<h2>writing...</h2>';
	var key = this.getAttribute('skey');
	lol(function() { lol(function() {
		localStorage.removeItem(key);
		put_day_db();
	})});
}
function ev_purge_all(e) {
	ebi('purgelist').innerHTML = '<h2>writing...</h2>';
	lol(function() { lol(function() {
		localStorage.clear();
		put_day_db();
	})});
}
var active_map = null;
function ev_map_sel_hall(e) {
	ev(e);
	var box = ebi('vmap');
	if (box.style.display == 'block' || active_map == null) {
		hide_modals();
		show_excl('vmaphall');
		return;
	}
	
	show_map(active_map);
}

function setzoom(v) {
	v = parseInt(v) || 10;
	zoom = isNaN(v) ? 10 : v;
	if (active_map)
		show_map();

	localStorage.setItem('zoom', zoom);

	var o = QSA('#vzoom a');
	for (var a = 0; a < o.length; a++) {
		o[a].onclick = ev_setzoom;
		o[a].setAttribute('class', parseInt(o[a].getAttribute('data-zoom'), 10) == zoom ? 'zoomsel' : '');
	}
}
function ev_setzoom(e) {
	setzoom(parseInt(this.getAttribute('data-zoom'), 10));
}

var ctx = ebi('map').getContext('2d');
var ctxr = (window.devicePixelRatio || 1) / (
	ctx.webkitBackingStorePixelRatio ||
	ctx.mozBackingStorePixelRatio ||
	ctx.msBackingStorePixelRatio ||
	ctx.oBackingStorePixelRatio ||
	ctx.BackingStorePixelRatio || 1);

if (ctxr < 1.9)
	ctxr *= 2;

function show_map() {
	tab('tbmenu_map');
	inf(['drawing map']);
	
	lol(function() { lol(function() {
		var sz = 12, // box size; webcata uses 10
			font1 = '24px sans-serif',
			font2 = '8px sans-serif';
		
		var mainhall = active_map;
		var subhalls = [];
		var rows = '';
		
		if (mainhall == '東123')
			subhalls = ['e1','e2','e3'];
		
		if (mainhall == '東456')
			subhalls = ['e4','e5','e6'];
		
		if (mainhall == '西12')
			subhalls = ['w1a','w1b','w2a','w2b'];
		
		for (var a = 0; a < HALLS.length; a++)
			for (var b = 0; b < subhalls.length; b++)
				if (HALLS[a] == subhalls[b])
					rows += ROWS[a];
		
		rows = rows.split('');
		//alert('showing map for ' + mainhall + ' (' + subhalls.join(',') + '); rows ' + rows.join(','));
		
		var minx =  99999;
		var maxx = -99999;
		var miny =  99999;
		var maxy = -99999;
		var rowmm = [];
		for (var a = 0; a < rows.length; a++)
			rowmm.push([99999,-99999,99999,-99999]);
		
		var booths = [];
		for (var a = 0, aa = dbday.length; a < aa; a++) {
			var tday = dbday[a];
			var loc = tday['loc'];
			var row = loc.slice(2, 3);
			var ridx = rows.indexOf(row);
			if (ridx === -1)
				continue;
			
			booths.push(dbday[a]);
			var x = parseInt(tday['x'], 10) * sz/10;
			var y = parseInt(tday['y'], 10) * sz/10;
			minx = Math.min(minx, x);
			maxx = Math.max(maxx, x);
			miny = Math.min(miny, y);
			maxy = Math.max(maxy, y);
			rowmm[ridx][0] = Math.min(rowmm[ridx][0], x);
			rowmm[ridx][1] = Math.max(rowmm[ridx][1], x);
			rowmm[ridx][2] = Math.min(rowmm[ridx][2], y);
			rowmm[ridx][3] = Math.max(rowmm[ridx][3], y);
		}

		var box = ebi('vmap');
		var can = ebi('map');
		//sw = box.innerWidth - box.offsetLeft;
		//sh = box.innerHeight - box.offsetTop;
		//var sw = parseInt(getComputedStyle(box)['width'], 10);
		//var sh = parseInt(getComputedStyle(box)['height'], 10);
		var sw = (maxx - minx) + minx * 2 + sz;
		var sh = (maxy - miny) + miny * 2 + sz;
		map.width = sw * ctxr + sz * 4;
		map.height = sh * ctxr + sz * 4;
		map.style.width = (sw*zoom/10) + 'px';
		map.style.height = (sh*zoom/10) + 'px';
		ctx.setTransform(ctxr, 0, 0, ctxr, sz * 2, sz);
		ctx.lineCap = 'butt';
		ctx.strokeStyle = '#231';
		
		ctx.fillStyle = '#573';
		ctx.font = font1;
		for (var a = 0; a < rows.length; a++) {
			var minx = rowmm[a][0];
			var maxx = rowmm[a][1];
			var miny = rowmm[a][2];
			var maxy = rowmm[a][3];
			if (minx == 99999)
				continue;
			
			var x, y;
			if (mainhall != '西12') {
				ctx.beginPath();
				ctx.moveTo(38.5 * sz, 0);
				ctx.lineTo(38.5 * sz, 100 * sz);
				ctx.stroke();
				
				ctx.beginPath();
				ctx.moveTo(74.5 * sz, 0);
				ctx.lineTo(74.5 * sz, 100 * sz);
				ctx.stroke();
			}
			else {
				ctx.beginPath();
				ctx.moveTo(45.5 * sz, 0);
				ctx.lineTo(45.5 * sz, 100 * sz);
				ctx.stroke();

				ctx.beginPath();
				ctx.moveTo(0, 30.5 * sz);
				ctx.lineTo(100 * sz, 30.5 * sz);
				ctx.stroke();
			}

			x = (minx + (maxx-minx)/2) + sz * 0.5;
			if (maxy - miny < 26 * sz)
				y = 11.8 * sz;
			else if (miny < 20 * sz)
				y = (miny + (maxy-miny)/1.9) + sz * 0.5;  //e123,456
			else
				y = (miny + (maxy-miny)/1.82) + sz * 0.5;

			if (maxx-minx>12.8*sz && maxy-miny>12.8*sz) {  // walls
				x = [
					minx + sz * 2.1,
					maxx - sz * 1.1
				];
				y = [
					miny + sz * 3,
					maxy + sz * 1
				];
			}

			if (!Array.isArray(x))
				x = [x];
			
			if (!Array.isArray(y))
				y = [y];
			
			for (var b = 0; b < x.length; b++)
				for (var c = 0; c < y.length; c++) {
					var tw = ctx.measureText(rows[a]).width;
					ctx.fillText(rows[a], x[b]-tw/2, y[c]);
				}
		}
		
		ctx.fillStyle = '#351';
		ctx.font = font2;
		if (!shitty_canvas_performance) {
			var last_loc = null;
			for (var a = 0; a < booths.length; a++) {
				var tday = booths[a];
				var loc = tday['loc'];
				var x = parseInt(tday['x'], 10) * sz/10 +(1.5);
				var y = parseInt(tday['y'], 10) * sz/10 +(sz-3);
				
				var tsel = get_tsel(loc);
				var scored = tsel && tsel['sc'] !== '-';
				
				if (scored)
					continue;
				
				loc = loc.slice(-3).slice(0,2);
				if (loc == last_loc && !scored)
					continue;
				
				ctx.fillText(loc.replace(/^0/, ' '), x, y);
				last_loc = loc;
			}
		}
		
		//ctx.translate(-0.5, -0.5);
		var n_renders = 2;
		for (var b = 0; b < n_renders; b++) {
			for (var a = 0, aa = booths.length; a < aa; a++) {
				var tday = booths[a];
				var loc = tday['loc'];
				var tsel = get_tsel(loc);
				
				var fill = tsel && tsel['sc'] !== '-';
				if (fill && b==0 || !fill && b==1)
					continue;
				
				var x = parseInt(tday['x'], 10) * sz/10;
				var y = parseInt(tday['y'], 10) * sz/10;
				
				ctx.fillStyle = '#000';
				if (tsel && cc.b[tsel['sc']])
					ctx.fillStyle = cc.b[tsel['sc']];

				if (tsel && tsel['done'])
					ctx.fillStyle = '#121';
				
				/*ctx.beginPath();
				if (loc.slice(-1) == 'a') {
					ctx.moveTo(x, y+sz);
					ctx.lineTo(x, y);
					ctx.lineTo(x+sz, y);
				}
				else {
					ctx.moveTo(x+sz, y);
					ctx.lineTo(x+sz, y+sz);
					ctx.lineTo(x, y+sz);
				}
				ctx.closePath();
				
				if (fill)
					ctx.fill();
				else {
					ctx.save();
					ctx.clip();
					ctx.stroke();
					ctx.stroke();
					ctx.stroke();
					ctx.restore();
				}*/
				
				var triangles = true;
				//triangles = false;
				
				if (fill) {
					ctx.beginPath();
					if (triangles) {
						if (loc.slice(-1) == 'a') {
							ctx.moveTo(x, y+sz);
							ctx.lineTo(x, y);
							ctx.lineTo(x+sz, y);
						}
						else {
							ctx.moveTo(x+sz, y);
							ctx.lineTo(x+sz, y+sz);
							ctx.lineTo(x, y+sz);
						}
					}
					else {
						// TODO:
						//   need the booth order csv field
						//   in order to fill the correct side
						var fill_top = loc.slice(-1) == 'a';
						var fill_bottom = !fill_top;

						if (fill_top) {
							ctx.moveTo(x,    y);
							ctx.lineTo(x+sz, y);
							ctx.lineTo(x+sz, y+sz/2);
							ctx.lineTo(x,    y+sz/2);
						}
						else if (fill_bottom) {
							ctx.moveTo(x,    y+sz/2);
							ctx.lineTo(x+sz, y+sz/2);
							ctx.lineTo(x+sz, y+sz);
							ctx.lineTo(x,    y+sz);
						}
					}
					ctx.closePath();
					ctx.fill();
				}
				else {
					ctx.strokeRect(x, y, sz, sz);
				}
				
				if (!shitty_canvas_performance && b == n_renders - 1) {
					ctx.fillStyle = (!tsel || tsel['done']) ?
						'#351' : cc.f[tsel['sc']];
					
					ctx.save();
					ctx.clip();
					var ntab = loc.slice(-3).slice(0,2);
					ctx.fillText(ntab.replace(/^0/, ' '), x + 1.5, y + (sz-3));
					ctx.restore();
				}
			}
			//ctx.translate(0.5, 0.5);
		}
		
		if (shitty_canvas_performance) {
			var last_loc = null;
			for (var a = 0; a < booths.length; a++) {
				var tday = booths[a];
				var loc = tday['loc'];
				var x = parseInt(tday['x'], 10) * sz/10 +(1);
				var y = parseInt(tday['y'], 10) * sz/10 +(sz-2);
				
				var tsel = get_tsel(loc);
				var scored = tsel && tsel['sc'] !== '-';
				
				loc = loc.slice(-3).slice(0,2);
				if (loc == last_loc && !scored)
					continue;
				
				if (scored) 
					ctx.fillStyle = cc.f[tsel['sc']];
				else
					ctx.fillStyle = '#351';
				
				ctx.fillText(loc.replace(/^0/, ' '), x, y);
				last_loc = loc;
			}
		}
		
		hide_modals();
		show('vmap');
	})});
}
function ev_showmap(e) {
	ev(e);
	active_map = this.textContent;
	show_map();
}
function canpos() {
	var can = ebi('map');
	can.onclick = function(e) {
		var rect = can.getBoundingClientRect(),
			scaleX = can.width / (rect.width * ctxr),
			scaleY = can.height / (rect.height * ctxr),
			x = (e.clientX - rect.left) * scaleX,
			y = (e.clientY - rect.top) * scaleY;
	
		alert(Math.floor(x) + '  ' + Math.floor(y));
	};
}
function ev_savecan(e) {
	ev(e);
	if (!active_map)
		return alert('choose a map first');

	var u = ebi('map').toDataURL('image/png'),
		a = document.createElement('a');
	
	a.setAttribute('href', u);
	a.setAttribute('download', 'c101-' + active_day + active_map + '.png');
	a.click();
	
	show_map(active_map);
}
//canpos();
function ev_resize(e) {
	draw_th(e);
	
	//if (ebi('vmap').style.display !== 'none')
	//	render();
	
	var h = parseInt(getComputedStyle(ebi('topnav'))['height'], 10);
	ebi('site').style.paddingTop = h + 'px';
}
function ev_cancel(e) {
	hide_modals(e);
	restore_scroll(true);
	
	var backto = this.getAttribute('goto');
	if (backto != null)
		show(backto);
	
	var invoke = this.getAttribute('invoke');
	if (invoke != null)
		window[invoke]();
}
function ev_add_qnote(e) {
	ev(e);
	var loc = ebi('ladd_loc').textContent;
	var txtbox = ebi('tqnote');
	var txt = txtbox.value;
	var sample = txtbox.getAttribute('sample');
	
	if (txt == '' || txt == sample) {
		alert('type a note or url in the field above first');
		return;
	}
	
	if (add_url(loc, txt))
		ebi('tqnote').value = sample;
	
	open_addctx();
}
function ev_dbg(e) {
	ev(e);
	v = prompt('give me javascript', 'localStorage.zsel2.length');
	alert(eval(v));
}
function ev_addctx_exit_action(e) {
	var name = this.getAttribute('id');
	
	if (name == 'raddlist')
		addctx_exit_act = 'list';
	
	if (name == 'raddnext')
		addctx_exit_act = 'next';
	
	localStorage.setItem('addctx_exit_act', addctx_exit_act);
}
function get_next_booth(last_booth) {
	if (last_booth === undefined)
		last_booth = ebi('ladd_loc').textContent;
	
	var found = false;
	for (var a = 0; a < BOOTHS.length; a++)
		if (BOOTHS[a]['loc'] == last_booth)
			found = true;
		else if (found == true)
			return BOOTHS[a]['loc'];
	
	return null;
}
function open_addctx(loc) {
	if (loc === undefined)
		loc = ebi('ladd_loc').textContent;
	
	var bscore = ebi('addctxscore').getElementsByTagName('a');
	for (var a = 0; a < bscore.length; a++)
		bscore[a].classList.remove('act');
	
	var tday = get_tday(loc);
	var tsel = get_tsel(loc);
	if (tday == null) {
		alert('could not find entry in dbday??');
		return;
	}
	
	var score = '-';
	if (tsel != null)
	{
		score = tsel['sc'];
		if (score !== '-')
		{
			bscore[parseInt(score)-1].classList.add('act');
		}
	}

	drawpic(loc);
	scroll_booth = loc;

	ebi('ladd_kan').textContent = tday['kan']
	ebi('ladd_rom').textContent = tday['rom']
	ebi('ladd_loc').textContent = loc;
	
	if (tsel && tsel['done']) {
		ebi('badd_done').textContent = '🔔 Set "Must Buy"';
		ebi('badd_done').style.background =
			'linear-gradient(90deg,#2c2c2c,#664422)';
	}
	else {
		ebi('badd_done').textContent = '💚 Set "Purchased"';
		ebi('badd_done').style.background =
			'linear-gradient(90deg,#2c2c2c,#446622)';
	}
	
	var html = [];
	if (tsel && tsel['url'])
		for (var a = 0; a < tsel['url'].length; a++)
		{
			var url = esc(tsel['url'][a]);
			html.push('<a target="_blank" href="' + url + '">🔖 ' + url + '</a>');
		}
	
	if (tday['url'])
		for (var a = 0; a < tday['url'].length; a++)
		{
			var url = esc(tday['url'][a]);
			html.push('<a target="_blank" href="' + url + '">🔗 ' + url + '</a>');
		}
	
	if (html.length > 0)
		html.push('🔗 = added by circle<br />🔖 = added by (You)'); <!-- 🍆 -->
	
	//var iday = get_iday(loc);
	//if (iday <= 0)
	
	ebi('addctxlinks').innerHTML = html.join('\n');
	ebi('trow_out').value = loc;
	
	gen_navkeys();
	show_excl('addctx');
}

function setenpic(en) {
	if (en !== true && en !== false) {
		if (enpic && en.target.nodeName.toLowerCase() != 'img')
			return;

		en = !enpic;
	}
	ebi('addctxsp').classList[en?'remove':'add']('ni');
	localStorage.setItem('enpic', en ? 'ye' : 'na');
	enpic = en;
	drawpic();
}
function drawpic(loc) {
	loc = loc || ebi('ladd_loc').textContent;
	ebi('addctxpic').innerHTML = enpic ? '<img src="i/' + loc + '.png" />' : '';
}

function ev_selskipmin_edit(e) {
	ev_cfg_int_edit(e);
	gen_navkeys();
}

function ev_boothnav(e) {
	ev(e);
	var tgt = this.getAttribute('tgt');
	if (tgt == '-')
		return alert('cannot navigate in this direction; no more booths matching criteria');
	
	return open_addctx(tgt);
	
	var bid = this.getAttribute('id').indexOf('bgotoprev') == 0 ?
		-1 : 1;
	
	var atlas = bid.slice(-3) == 'sel' ?
		BOOTHS : dbday;
}

function gen_navkeytxt(bid, loc) {
	var obj = ebi(bid);
	if (loc == null) {
		obj.textContent = 'EOF';
		obj.setAttribute('tgt', '-');
		return;
	}
	
	var tday = get_tday(loc);
	var tsel = get_tsel(loc);
	obj.setAttribute('tgt', tday['loc']);
	ebi(bid).innerHTML =
		tday['loc'] + '<span>' +
		(tsel == null ? '-' : tsel['sc']) + '</span><br />' +
		esc(tday['kan']) + '<br />' +
		esc(tday['rom']);
	
	var cidx = tsel == null ? '-' : tsel['sc'];
	obj.style.background = cc.b[cidx];
	obj.style.color = cc.f[cidx];
	//alert(cc.b[cidx]);
}
function gen_navkeys() {
	var iday = get_iday();
	var iboo = get_ibooth();
	
	gen_navkeytxt('bgotoprevday', iday > 0 ? dbday[iday-1]['loc'] : null);
	gen_navkeytxt('bgotonextday', iday + 1 < dbday.length ? dbday[iday+1]['loc'] : null);
	
	var sloc = null;
	var i = iboo - 1;
	while (i > 0) {
		var tsel = get_tsel(BOOTHS[i]['loc']);
		if (selskipmin == 0 || (tsel && tsel['sc'] >= selskipmin)) {
			sloc = BOOTHS[i]['loc'];
			break;
		}
		i--;
	}
	gen_navkeytxt('bgotoprevsel', sloc);
	
	var sloc = null;
	var i = iboo + 1;
	while (i < BOOTHS.length) {
		var tsel = get_tsel(BOOTHS[i]['loc']);
		if (selskipmin == 0 || (tsel && tsel['sc'] >= selskipmin)) {
			sloc = BOOTHS[i]['loc'];
			break;
		}
		i++;
	}
	gen_navkeytxt('bgotonextsel', sloc);
}
function ev_scrollto(e) {
	var href = this.getAttribute('href').slice(1);
	var tgt = ebi(href);
	//var cs = getComputedStyle(tgt);
	var pad = parseInt(ebi('site').style.paddingTop, 10);
	var ofs = parseInt(tgt.offsetTop, 10) + pad;
	
	if (scroll_obj === null)
		get_scroll_offset();
	
	if (scroll_obj !== null) {
		ev(e);
		scroll_obj.scrollTop = ofs - pad;
	}
}
function ev_srchcfg(e) {
	ev(e);
	hide_modals();
	show_excl('vsrchcfg');
}

window.onkeydown = function(e) {
	if (e.ctrlKey || e.altKey || e.metaKey || e.isComposing)
		return;

	var k = e.code + '',
		ae = document.activeElement,
		aet = ae && ae != document.body ? ae.nodeName.toLowerCase() : '';

	if (k == 'Enter' && aet == 'input')
		try {
			ae.nextElementSibling.onclick();
		}
		catch (ex) {}

	if (aet && aet != 'a' && aet != 'tr' && aet != 'pre')
		return;

	if (k == 'Escape')
		for (var a of QSA('.bcancel'))
			if (a.parentNode.style.display === 'block')
				return a.onclick();

	if (k == 'KeyM')
		ev_map_sel_hall();

	if (k == 'KeyU') {
		if (isvis('addctx'))
			return ev_urls();
	}

	if (k == 'KeyD') {
		if (isvis('vurls_edit'))
			return ev_url_delete();
		
		return show_chday();
	}

	if (k.indexOf('Digit') === 0) {
		var n = parseInt(k.slice(-1));

		if (isvis('addctx'))
			return ebi('badd_r' + n).onclick();
		
		if (isvis('vmaphall'))
			return QS('#vmaphall>a:nth-child(' + (n+1) + ')').onclick();
		
		if (isvis('vday'))
			return QS('#vday>a:nth-child(' + (n+1) + ')').onclick();
	}
}


ebi('bmenu').onclick = show_menu;
ebi('tbmenu_day').onclick = show_chday;
ebi('bmenu_day').onclick = show_chday;
ebi('bmenu_day1').onclick = ev_chday;
try {
	ebi('bmenu_day2').onclick = ev_chday;
	ebi('bmenu_day3').onclick = ev_chday;
	ebi('bmenu_day4').onclick = ev_chday;
}
catch (ex) { }
ebi('bmenu_dload').onclick = ev_dload;
//ebi('tbmenu_cir').onclick = ev_cirtype;
ebi('bmenu_cir').onclick = ev_cirtype;
ebi('bmenu_cirkan').onclick = ev_cirkan;
ebi('bmenu_cirrom').onclick = ev_cirrom;
ebi('tbmenu_row').onclick = ev_row;
ebi('bmenu_row').onclick = ev_row;
ebi('tbmenu_srch').onclick = ev_srch;
ebi('bmenu_srch').onclick = ev_srch;
ebi('brow_list').onclick = ev_listrows;
ebi('brow_prev').onclick = ev_steprow;
ebi('brow_next').onclick = ev_steprow;
ebi('tbmenu_chk').onclick = ev_added;
ebi('bmenu_chk').onclick = ev_added;
ebi('trow_in').onfocus = ev_focus;
ebi('trow_in').onblur = ev_blur;
ebi('trow_in').oninput = ev_trowin_input;
ebi('bmenu_import').onclick = ev_import;
ebi('bmenu_export').onclick = ev_export;
ebi('export_download').onclick = ev_export_file;
ebi('import_file').onchange = ev_import_file;
ebi('bimport_text').onclick = ev_import_text;
ebi('bmenu_settings').onclick = ev_cfg;
ebi('bcfg_srch').onclick = ev_srchcfg;
ebi('bcfg_colors').onclick = ev_cfg_colors;
ebi('badd_done').onclick = ev_purchased;
ebi('badd_rem').onclick = ev_remove;
ebi('bdel_yes').onclick = ev_remove_ok;
ebi('addctxpic').onclick = setenpic;
ebi('tsrch').onfocus = ev_focus;
ebi('tsrch').onblur = ev_blur;
ebi('tsrch').oninput = ev_tsch_input;
ebi('badd_urls').onclick = ev_urls;
ebi('burl_new').onclick = ev_url_new;
ebi('burl_add').onclick = ev_url_new_done;
ebi('burl_edit').onclick = ev_url_edit_save;
ebi('burl_del').onclick = ev_url_delete;
ebi('tbmenu_map').onclick = ev_map_sel_hall;
ebi('bmenu_map').onclick = ev_map_sel_hall;
ebi('bzoom').onclick = function () { show_excl('vzoom'); };
ebi('bsave').onclick = ev_savecan;
ebi('bmaphall_e123').onclick = ev_showmap
ebi('bmaphall_e456').onclick = ev_showmap
ebi('bmaphall_w12').onclick = ev_showmap
try {
	ebi('bmaphall_w34').onclick = ev_showmap
}
catch(ex) { }
ebi('bqnote').onclick = ev_add_qnote;
ebi('tqnote').onfocus = ev_focus;
ebi('tqnote').onblur = ev_blur;
ebi('dbg').onclick = ev_dbg;
ebi('selskipmin').oninput = ev_selskipmin_edit;
ebi('bgotoprevsel').onclick = ev_boothnav;
ebi('bgotonextsel').onclick = ev_boothnav;
ebi('bgotoprevday').onclick = ev_boothnav;
ebi('bgotonextday').onclick = ev_boothnav;
ebi('bsrchcfg').onclick = ev_srchcfg;


var t = QSA('.bcancel');
for (var a=0; a<t.length; a++)
	t[a].onclick = ev_cancel;

var t = ebi('addctx_exit_act').getElementsByTagName('input');
for (var a=0; a<t.length; a++)
	t[a].onchange = ev_addctx_exit_action;


window.onresize = ev_resize;


// state init
inf(['resuming previous session ...']);
lol(function() { lol(function() {
	load_day();
})});

//ev_row();
//ev_import();
//ev_map_sel_hall();

//active_map = '東123';
//active_map = '西12';
//setTimeout(show_map, 10);

//setTimeout(function() { open_addctx('1東G15b'); }, 10);
//setTimeout(ev_cfg_colors, 100);


/*
cat Documents/all-comiket-rows.txt | shuf | while IFS= read -r x; do printf '{"loc":"2%s01a","sc":"7"},\n' "$x"; done > ~/Downloads/battleplan-shuffled.json 

while true; do for sc in 4 5 6 7 8 9 8 7 6 5; do IFS= read -r row; [ -z "$row" ] && break; printf '{"loc":"2%s01a","sc":"%s"},\n' "$row" "$sc"; done; [ -z "$row" ] && break; done < <(cat ~/Documents/all-comiket-rows.txt;) > ~/Downloads/battleplan-rainbow.json 

{ echo '{"sel2":['; r=3; for row in シ ス セ ソ タ チ ツ テ ト ナ ニ ヌ ネ; do for n in {01..91}; do for c in a b; do r=$((r+1)); [ $r -gt 9 ] && r=4; printf '{"loc":"2東%s%s%s","sc":"%s"},\n' $row $n $c $r; done; done; done; } | xclip -i -selection clipboard
*/
</script></body></html>
